<!-- PRINT Headline Rule for total chemical GROUP as denoted by Silent Spring using a separate RMD file-->

<!--  Headlines for amount detected (by chemical group)     
We propose applying these headlines to each chemical group separately. The participant would receive the top priority headline that applies for each chemical group. The headlines are not exhaustive (i.e., not all participants will necessarily receive a headline for every group). The headlines are intended to highlight particularly high or low.  

SubClassScores seemss to already have manny values.  It shows how any of each category each person has.  SO for each CLASS (i.e. "Chemicals in Commerce") 
BUT subclassscores doesn't have enough detail to do this

You had some {group name} detected in your wristband that were not found in most others.

NEED to add "classification" if it isn't already to the big result table.  THEN we can do anything w/ a query on that table.

THIS IS COMPLICATED and unclear what I really want to display... TBD.

-->

## Key Messages By Chemical Classification

```{r printMessageForTotalChemByGroup, results='asis', echo=FALSE, message=FALSE,fig.width=10, fig.height=4}

testResults.bigWithClass  <- testResults.big %>%
  #filter(Result > 0) %>% # choose only hits
  left_join(class_L, by = "ParameterID",relationship = "many-to-many") %>%
  select(ParameterID,ParameterName,SampleNumber,Result, classification)

# ADDING CLASSIFICATION to testResults.big BUT NOTE that this creates duplicate rows cause some parameterID have multiple class SO
#   ONLY use this when necessary to lookup CLASS
### NOTE NOPE NOTE:   I went back to base code, and made sure that EVERY data file, including DRS had one row for each unique combo of sampleNumber and ParameterID


#str(testResults.bigNoZeroWithClass)
#str(testResults.bigWithClass)



# Define the function
generate_report <- function(sampleNumber, testResults,debug=FALSE, debug2=FALSE) {
  #sampleNumber <- subject
  #testResults <-testResults.bigWithClass 
  #debug=TRUE

  calculate_percentile <- function(x, percentile) {
    quantile(x, probs = percentile / 100, na.rm = TRUE)
  }

  individual_data <- testResults %>% filter(SampleNumber == sampleNumber)
  classifications <- unique(testResults$classification)
  messages <- c()
  message<-NULL

  #class<-"Flame Retardant"
  #class<-"Pesticides"
  for (class in classifications) {
    #class <- "Agricultural & Pharmaceutical Chemicals"   # USING THIS to step trace and debug if message is correct

    if(debug){cat("in classification loop, classification = ",class, "   messages= ",messages, " message = ",message,"\n")}


    class_data <- testResults %>% filter(classification == class)  # This is all the testResults that have any rows with this specific class
    sample_count <- length(unique(testResults$SampleNumber))   # this is total # of samples since includes ZERO is that correct??
    compounds_meeting_criteria1 <- c()
    compounds_meeting_criteria2 <- c()
    compounds_meeting_criteria3 <- c()
    compounds_meeting_criteria4 <- c()
    compounds_meeting_criteria5 <- c()
    compounds_meeting_criteria6 <- c()
    compounds_meeting_criteria7 <- c()
    compounds_meeting_criteria8 <- c()

    #compound <-"TPP"
    #compound <-"Tributyl phosphate"
    #compound <-"PBDE 47"
    #compound <-"Tris(2-ethylhexyl) phosphate"
    #compound <-"Tricresylphosphate, meta-"
    #compound <-"TCPP"



    #compound <- "Fipronil" #is a Pesticide
    for (compound in unique(class_data$ParameterName)) {   # Loop thru all the compounds that are in this class anywhere in the data (not just this subject)
      compound <- "Trans-Nonachlor"

      if(debug){cat("in compound loop, compound = ",compound, "  class = ",class,  "messages= ", messages, "\n")}

      compound_data <- class_data %>% filter(ParameterName == compound)  # Here are all the results for all the wristbands that have any score (including ZERO) for this compound
      pct_95 <- calculate_percentile(compound_data$Result, 95)
      pct_75 <- calculate_percentile(compound_data$Result, 75)
      pct_50 <- calculate_percentile(compound_data$Result, 50)
      pct_25 <- calculate_percentile(compound_data$Result, 25)
      median_result <- median(compound_data$Result, na.rm = TRUE)

      if(debug){cat("\n Compound =",compound," Class= ",class,"\n")}
      if(debug){cat("pct95=", pct_95, " pct_75=", pct_75, " pct_50=", pct_50, " pct25=", pct_25,"  median=",median_result,"\n")}


      # Criteria 1: Result >= 95th percentile and found in <= 10% of samples
      if (any(individual_data$Result > 0 & 
              individual_data$ParameterName == compound &
              individual_data$Result >= pct_95) &&
          (sum(compound_data$Result > 0) / sample_count) <= 0.10) {
        compounds_meeting_criteria1 <- c(compounds_meeting_criteria1, compound)
      }
      # Criteria 2: Result >= 95th percentile and > 10 times the median
      if (any(
        individual_data$Result > 0 & 
        individual_data$ParameterName == compound &
        individual_data$Result >= pct_95 &
        individual_data$Result >= (10 * median_result)
      ))    {
        compounds_meeting_criteria2 <- c(compounds_meeting_criteria2, compound)
      }
      # Criteria 3: Result >= 95th percentile and >10 of individuals HAD this compound
      if (any(
        individual_data$Result > 0 & 
        individual_data$ParameterName == compound &
        individual_data$Result >= pct_95) &&
          (sum(compound_data$Result > 0) / sample_count) >= 0.10)      {
        compounds_meeting_criteria3 <- c(compounds_meeting_criteria3, compound)
      }
      # # Criteria 4: Result >= 75th percentile and 10x median
      if (any(
        individual_data$Result > 0 & 
        individual_data$ParameterName == compound &
        individual_data$Result >= pct_75 &
        (individual_data$Result > 10 * median_result)
      ))      {
        compounds_meeting_criteria4 <- c(compounds_meeting_criteria4, compound)
      }


      # Criteria 5: Result > 75th percentile and 25% measurements are detects
      if (any(
        individual_data$Result > 0 & 
        individual_data$ParameterName == compound &
        individual_data$Result >= pct_75) &&
          (sum(compound_data$Result > 0) / sample_count) >= 0.25)      {
        compounds_meeting_criteria5 <- c(compounds_meeting_criteria5, compound)
      }

      # Criteria 6: No detected compounds from this group
      if (!any(individual_data$ParameterName == compound)) {
        compounds_meeting_criteria6 <- c(compounds_meeting_criteria6, compound)
      }

      # Criteria 7: Result < 50th percentile for all compounds in group
      if (all(
        individual_data$Result > 0 & 
        individual_data$ParameterName == compound &
        individual_data$Result <= pct_50)) {
        compounds_meeting_criteria7 <- c(compounds_meeting_criteria7, compound)
      }


      # Criteria 8: Not detected for a chemical and â‰¤10% of all measurements are non-detects
      if (all(individual_data$ParameterName == compound &
              individual_data$Result == 0) &&
          (sum(compound_data$Result > 0) / sample_count) <= 0.10)   {
        compounds_meeting_criteria8 <- c(compounds_meeting_criteria8, compound)
      }

    }

    if(debug2){cat("Just left setting up Criteria in loop and Criterial 1 through 8 are" ,"\n",
        "crit1=",compounds_meeting_criteria1, "\n",
        "crit2=",compounds_meeting_criteria2 ,"\n",
        "crit3=",compounds_meeting_criteria3,"\n",
        "crit4=",compounds_meeting_criteria4,"\n",
        "crit5=",compounds_meeting_criteria5,"\n",
        "crit6=",compounds_meeting_criteria6,"\n",
        "crit7=",compounds_meeting_criteria7,"\n",
        "crit8=",compounds_meeting_criteria8 ,"\n",
        "message= ",message, "\n",
        "messages= ",messages, "\n",

        "END OF CRITERIA PRINTING")}



    if (length(compounds_meeting_criteria1) > 1) {
      message <- paste(
        "You had some",
        class,
        " detected that were not found in most others."
      )
    } else if (length(compounds_meeting_criteria1) == 1) {
      compound <- individual_data$ParameterName[individual_data$Result >= pct_95 &
                                                  (sum(class_data$Result > 0) / sample_count) <= 0.10]
      message <- paste(
        "You had exactly one",
        class,
        "compound,",
        compound,
        ". It was not found in most others."
      )
    } else if (length(compounds_meeting_criteria2) > 1) {
      message <- paste(
        "You had higher levels of",
        class,
        "compared to 95% of the other people."
      )
    } else if (length(compounds_meeting_criteria2) == 1) {
      compound <- individual_data$ParameterName[individual_data$Result >= pct_95 &
                                                  individual_data$Result > 10 * median_result]
      message <- paste(
        "You had exactly exactly one",
        class,
        "compound,",
        compound,
        " that was higher than 95% of the other people."
      )
    } else if (length(compounds_meeting_criteria3) > 0) {
      message <- paste(
        "You had higher levels of",
        class,
        "compared to 95% of the other people."
      )
    } else if (length(compounds_meeting_criteria4) > 0) {
      message <- paste(
        "You had higher levels of",
        class,
        "compared to 75% of the other people. Some of your numbers are much higher than most others"
      )
    } else if (length(compounds_meeting_criteria5) > 0) {
      message <- paste(
        "You had higher levels of",
        class,
        "compared to 75% of the other people."
      )
    } else if (length(compounds_meeting_criteria6) > 0) {
      message <- paste("YYou had no ",
                       class,
                       " {group name} detected.")
    } else if (length(compounds_meeting_criteria7) > 0) {
      message <- paste("You had lower levels of",
                       class,
                       "than most others.")
    } else if (length(compounds_meeting_criteria8) > 0) {
      message <- paste(
        "You did not have some ",
        class,
        "detected. It was found in most others."
      )
    } 


    # Append the message to the vector
    messages <- c(messages, message)
    message <-NULL
  }
  if(debug){cat ("\n about to return with messages = ",messages,"\n")}
  return(messages)
}





# Call the function
report_messages <- generate_report(subject, testResults.bigWithClass)
#report_messages <- generate_report(subject, testResults.bigWithClass,TRUE,TRUE)


# Print the messages
#cat(paste0("* ", report_messages, collapse = "\n* "), "\n")

# Print the messages
for (message in report_messages) {
  cat("* ", message, "\n")
}

#generate_report("AAG0AAG", testResults.bigWithClass)
#generate_report("AAG0AC0", testResults.bigWithClass)
#generate_report("AAGA00C", testResults.bigWithClass)
#generate_report("AAGA009", testResults.bigWithClass)
#generate_report("AAG0CAA", testResults.bigWithClass)
#generate_report("AAG0CAE", testResults.bigWithClass)


cat("\n\n **This is not yet tested FULLY.  This is to print HEADLINE RULES by CHEM GROUP if we decide to do that** \n")


# 
```
