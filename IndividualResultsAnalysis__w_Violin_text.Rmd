---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Individual Results `r tabsetting`


```{r IRiS_Prop65_IARC_Individual_Results_COMBINED_NEW, results='asis', echo=FALSE, message=FALSE, fig.width=6, fig.height=8,fig.cap="",dpi=150,eval=DoSpecificSubjectAnalysis}
## The function to build a violin plot is now in a separate R file
source("BuildViolinPlot.R")


# Make list of all chemicals that our ONE user had that showed up in "any" of the databases
##  NOTE: I really should do this with ParameterName but didn't have that  handy... should fix
#

# chemsOfConcern <- (union(union(oneResultCalifProp65Risk$`Chemical Name`,oneResultEpaIris$`Chemical Name`),
#      oneResultIARCRisk$`Chemical Name`))
#
### ONLY DOING PROP65 and EPA IRIS... dropping IARC cause not as interseting?
chemsOfConcern <- union(oneResultCalifProp65Risk$`Chemical Name`, oneResultEpaIris$`Chemical Name`)


## Make a list of all chemicals that our one user had that did NOT show up in any of the databases
chemsNOTinConcernGroup <- oneResult_with_Y_flag$ParameterName[!(oneResult_with_Y_flag$ParameterName %in% chemsOfConcern)]
```


## Plot each Chemical of Concern {.tabset  .tabset-pills}


```{r PlotChemsOfConcern_Part1, include=FALSE}
# THIS weird few LINES is not really important except somehow by ploting, but not including (include=FALSE) this enables the rest to work?
fig <- ggplot(cars) +
  geom_point(aes(speed, dist))
htmltools::tagList(ggplotly(fig))


### This next section is to figure how HOW MANY people HAD this compound and how many didn't
howManyHaveParameterName <- testResults.big %>%
  group_by(ParameterName) %>%
  summarise(non_zero_count = sum(Result != 0))


# Function to look up non_zero_count for a specific ParameterName
lookup_non_zero_count <- function(parameter_name, howManyHaveParameterName) {
  result <- howManyHaveParameterName %>%
    filter(ParameterName == parameter_name) %>%
    pull(non_zero_count)
  return(result)
}

# Example usage
# parameter_name_to_lookup <- "Trans-Nonachlor"  # Replace with your ParameterID
# non_zero_count_value <- lookup_non_zero_count(parameter_name_to_lookup, howManyHaveParameterName)
# print(non_zero_count_value)
```

We checked all the chemicals you were exposed to in databases that flag harmful chemicals. Just because a chemical is flagged doesn't mean the amount you were exposed to is harmful. Also, many chemicals haven't been tested for safety, so not being in a database doesn't mean it's safe. We compared your results to others in the study.  **Click** each chemical name to see how your exposure compares.

```{r PlotChemsOfConcern_Part2, results='asis',echo=FALSE,eval=TRUE}
###
### using variou web links to figure out...this is supposed to work... ineed to check this again...
###  THIS LOOKS GOOD:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops
######   THIS ONE GAVE ANSWER BELOW:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops


if (length(chemsOfConcern) >= 1) {
  for (i in 1:length(chemsOfConcern)) {
    chemOfConcern <- chemsOfConcern[i]
    # chemOfConcern <- chemsOfConcern[2]
    # chemOfConcern <- chemsOfConcern[1]


    # NOW make a table of all the users that had the one chemical of concern that we selected which our one user had
    testResults_ChemOfConcern <- testResults.big %>%
      filter(ParameterName == chemOfConcern) %>%
      select(SampleNumber, Result, ParameterName)


    if (nrow(testResults_ChemOfConcern) > 1) {
      cat("###", chemOfConcern, "{-}", "\n\n")

      print(htmltools::tagList(
        buildPlotlyViolin(chemOfConcern, testResults_ChemOfConcern)
      ))

      newMessage <- NULL

      newMessage <- paste(
        newMessage,
        " ",
        chemOfConcern,
        " was found on ",
        lookup_non_zero_count(chemOfConcern, howManyHaveParameterName),
        "out of the ",
        howManyWristbandsTested,
        "wristbands."
      )



      # newMessage <- paste(
      #   newMessage,
      #   chemOfConcern,
      #   ' was found in one or more online databases as being of some concern. '
      # )




      testInPROP65 <- oneResultCalifProp65Risk %>%
        filter(`Chemical Name` == chemOfConcern)
      if (nrow(testInPROP65) > 0) {
        PROP65_info <- testInPROP65$`Risk Type Per California Prop 65`


        Prop65_Link <- "http://www.oehha.ca.gov/prop65.html"
        Prop65_Link <- paste0("<a href='", Prop65_Link, "' target='_blank'>", Prop65_Link, "</a>") ## This should make the link open in new tab


        newMessage <- paste(
          newMessage,
          " ",
          " This chemical is classified per California Proposition 65 (",
          Prop65_Link,
          " ) ",
          " with the risk type noted as: ",
          PROP65_info,
          "."
        )
      }

      ##### DELETED IARC cause Silent Spring suggested gettign rid
      # testInIARC <- oneResultIARCRisk %>%
      #   filter(`Chemical Name` == chemOfConcern)
      #  if (nrow(testInIARC) > 0) {
      #    IARC_info <- testInIARC$`Risk Type Per IARC`
      #    newMessage <- paste (newMessage,  " ",
      #                         " This chemical is classified by the International Agency for the Research on Cancer ",
      #                         " as a chemical of concern.  It is classified as: ",  IARC_info,".")
      #  }

      testInIRIS <- oneResultEpaIris %>%
        filter(`Chemical Name` == chemOfConcern)
      if (nrow(testInIRIS) > 0) {
        IRIS_info <- testInIRIS$`IRIS Summary Web Link`
        IRIS_info <- paste0("<a href='", IRIS_info, "' target='_blank'>", IRIS_info, "</a>") ## This should make the link open in new tab
        newMessage <- paste(
          newMessage,
          " ",
          "The Environmental Protection Agency has classified this chemical ",
          " as a chemical of concern.  You can find more information here: ",
          IRIS_info,
          " . "
        )
      }

      testInChemSourceMitigation <- chemSourceMitigation %>%
        filter(Chemical_Name == chemOfConcern)
      chemSourceMitigationMessage<-"\n\n"
      if (nrow(testInChemSourceMitigation) > 0) {
        chemSourceMitigationMessage <- paste0(
          chemSourceMitigationMessage,
          "This compound is suspected of having the following health effects: **",
          testInChemSourceMitigation$Summary_of_Health_Effects,
          "**. ",
          " Sources of Exposure to this compound are frequently due to:  **",
          testInChemSourceMitigation$Sources_of_Exposure,
          #testInChemSourceMitigation$Commercial_Products  This was from the first try, SOURCES of exposure seems like better data
          "**. ",
          " Possible ways to avoid exposure to this compound include: **",
          testInChemSourceMitigation$Mitigation_Strategies,
          "**."
        )
        newMessage <- paste(newMessage, " ", chemSourceMitigationMessage)
      }




      cat(newMessage)

      # HERE i can add some stuff about sources of exposure, health impacts, mitigation strategies
      # Learn about actions that could help reduce your exposure



      cat(" \n \n")
    }
  }
} else {
  testResults_ChemOfConcern <- testResults.big %>%
    filter(ParameterName == "NEVER MATCH") %>%
    select(SampleNumber, Result, ParameterName)
}
```




<!-- NOW let's loop through all the classifications FOUND ON THIS subject wristband
    and let's for each classification say  
    "You have X chemicals with the classification Y"
    These chemicals are:  LIST. 
    Below you will see any specific recommendations, per chemical, followed by generic recommendations on routes of possible exposure and ways to reduce your exposure.
    SO WE WANT OUTPUT LIKE
          Classification:  Personal Care
          Your Personal Care Chemicals: A B C
          Ways to address these, if any:
          A -:> 
          B- >
          General  Advice regarding this class of compounds
          
          WE COULD DO THIS or we could put the information directly after the chemical information?
    
-->
```{r ListAllCompoundsInClassWithInfo , results='asis',echo=FALSE,eval=TRUE}
```


## Plot Remaining Chemicals {.tabset  .tabset-pills}


```{r PlotOtherChems_Part1, include=FALSE}
# THIS weird few LINES is not really important except somehow by ploting, but not including (include=FALSE) this enables the rest to work?
fig <- ggplot(cars) +
  geom_point(aes(speed, dist))
htmltools::tagList(ggplotly(fig))


### This next section is to figure how HOW MANY people HAD this compound and how many didn't
howManyHaveParameterName <- testResults.big %>%
  group_by(ParameterName) %>%
  summarise(non_zero_count = sum(Result != 0))


# Function to look up non_zero_count for a specific ParameterName
lookup_non_zero_count <- function(parameter_name, howManyHaveParameterName) {
  result <- howManyHaveParameterName %>%
    filter(ParameterName == parameter_name) %>%
    pull(non_zero_count)
  return(result)
}

# Example usage
# parameter_name_to_lookup <- "Trans-Nonachlor"  # Replace with your ParameterID
# non_zero_count_value <- lookup_non_zero_count(parameter_name_to_lookup, howManyHaveParameterName)
# print(non_zero_count_value)
```


Besides the chemicals already mentioned, other chemicals were also found on your wristband. Many chemicals haven't been tested for safety, so not being in a database doesn’t mean it’s safe, but it also doesn’t mean it’s harmful. **Click** on each chemical name to compare your exposure to others in the study.



```{r PlotOtherChems_Part2, results='asis',echo=FALSE,eval=TRUE}
###
### using variou web links to figure out...this is supposed to work... ineed to check this again...
###  THIS LOOKS GOOD:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops
######   THIS ONE GAVE ANSWER BELOW:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops


if (length(chemsNOTinConcernGroup >= 1)) {
  for (i in 1:length(chemsNOTinConcernGroup)) {
    chemNOTinConcernGroup <- chemsNOTinConcernGroup[i]
    # chemOfConcern <- chemsOfConcern[9]
    # chemOfConcern <- chemsOfConcern[1]


    # NOW make a table of all the users that had the one chemical of concern that we selected which our one user had
    testResults_ChemNOTinConcern <- testResults.big %>%
      filter(ParameterName == chemNOTinConcernGroup) %>%
      select(SampleNumber, Result, ParameterName)


    if (nrow(testResults_ChemNOTinConcern) > 1) {
      cat("###", chemNOTinConcernGroup, "{-}", "\n\n")

      print(htmltools::tagList(
        buildPlotlyViolin(chemNOTinConcernGroup, testResults_ChemNOTinConcern)
      ))

      newMessage <- NULL

      newMessage <- paste(
        newMessage,
        " ",
        chemNOTinConcernGroup,
        " was found on ",
        lookup_non_zero_count(chemNOTinConcernGroup, howManyHaveParameterName),
        "out of the ",
        howManyWristbandsTested,
        "wristbands. "
      )


      testInChemSourceMitigation <- chemSourceMitigation %>%
        filter(Chemical_Name == chemNOTinConcernGroup)
      if (nrow(testInChemSourceMitigation) > 0) {
        chemSourceMitigationMessage <- "\n\n Although this chemical was not listed in any searched database it may still have harmful effects at certain levels but we do NOT know how your levels compare to that. "
        chemSourceMitigationMessage <- paste0(
          chemSourceMitigationMessage,
          "This compound is suspected of having the following health effects: **",
          testInChemSourceMitigation$Summary_of_Health_Effects,
          "**. ",
          " Sources of Exposure to this compound are frequently due to:  **",
          testInChemSourceMitigation$Sources_of_Exposure,
          #testInChemSourceMitigation$Commercial_Products  This was from the first try, SOURCES of exposure seems like better data
          "**. ",
          " Possible ways to avoid exposure to this compound include: **",
          testInChemSourceMitigation$Mitigation_Strategies,
          "**."
        )
        newMessage <- paste(newMessage, " ", chemSourceMitigationMessage)
      }

      cat(newMessage)

      cat(" \n \n")
    }
  }
} else {
  testResults_ChemNOTinConcern <- testResults.big %>%   # NOT SURE WHY WE ARE DOING THIS ELSE TEST...Perhaps to catch error?
    filter(ParameterName == "NEVER MATCH") %>%
    select(SampleNumber, Result, ParameterName)
}
```






## Individual: Chemical Info



```{r IndividualChemicalListWithClassification, child='IndividualChemicalListWithClassification_text.Rmd', eval = !HideClassificationInformation}
```


```{r IndividualChemicalListWithOutClassification, child='IndividualChemicalListWithOutClassification_text.Rmd', eval = HideClassificationInformation}
```



```{r IndividualClassificationShowingChemicalsAndAverages, child='IndividualClassificationShowingChemicalsAndAverages_text.Rmd', eval = !HideClassificationInformation}
```




```{r StatisticsOnAllChemicalsFound, child='StatisticsOnChemicalsFound.Rmd', eval = TRUE}
```




### Individual Percentage vs Maximum 


Another way to view the data is by comparing how much of a chemical you had compared to the maximum found in any wristband. For example, if wristband-A had 100 nanograms and the maximum was 1,000 nanograms, wristband-A had 10% of the maximum. The chart below shows the percentage of the maximum for each chemical found on your wristband.

`r if(nrow(testResults.big[testResults.big[, "Flag"] == "Y", ])>0){"Any wristbands where we detected a chemical, but could not quantify it, are suppressed from this chart below"}`


```{r chart_x5_perc_values, echo=FALSE, message=FALSE, fig.height=12,fig.cap="",dpi=150}
################ BEGIN x5 Perc

##
perc_values <- testResults.big %>% #
  filter(SampleNumber == subject) %>%
  filter(Result > 0) %>%
  select(ParameterName, norm_Result)

c <- ggplot(perc_values, aes(y = norm_Result, factor(ParameterName))) +
  # geom_bar(stat="identity")+
  geom_bar(stat = "identity", fill = "blue", colour = "black") +
  labs(
    x = "All Chemicals Found on Your Wristband",
    y = "Percent of Max value Found",
    title = paste(
      "Your Percentage of Max Exposure\n",
      "Found per Chemical\n",
      "Subject = ", subject
    )
  )
# c

axis.text.x.size <- 6 # JUST changed to be a variable
if (howManyUniqueChemFoundAcrossAllWristbands < 60) axis.text.x.size <- 10
c <- c + theme(
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  axis.title.x = element_blank(),
  axis.text.x = element_text(angle = 90, vjust = .1, hjust = 1, size = axis.text.x.size),
  #           axis.text.x = element_text(angle = 45,vjust=1,hjust=1,size=6 ),

  legend.position = "none",
  panel.background = element_blank(),
  panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  plot.background = element_blank()
)

# c <- c + scale_y_continuous(labels=percent, limits=c(0,1))
c <- c + scale_y_continuous(labels = percent)
c + coord_flip()


rm(c, perc_values)
```

<br>
<br>
