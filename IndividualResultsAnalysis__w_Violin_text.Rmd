---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Individual Results `r tabsetting`


```{r IRiS_Prop65_IARC_Individual_Results_COMBINED_NEW, results='asis', echo=FALSE, message=FALSE, fig.width=6, fig.height=8,fig.cap="",dpi=150,eval=DoSpecificSubjectAnalysis}

## The function to build a violin plot is now in a separate R file
source("BuildViolinPlot.R")


# Make list of all chemicals that our ONE user had that showed up in "any" of the databases
##  NOTE: I really should do this with ParameterName but didn't have that  handy... should fix
#

#chemsOfConcern <- (union(union(oneResultCalifProp65Risk$`Chemical Name`,oneResultEpaIris$`Chemical Name`),
#      oneResultIARCRisk$`Chemical Name`))
#
### ONLY DOING PROP65 and EPA IRIS... dropping IARC cause not as interseting?
chemsOfConcern <- union(oneResultCalifProp65Risk$`Chemical Name`,oneResultEpaIris$`Chemical Name`)


## Make a list of all chemicals that our one user had that did NOT show up in any of the databases
chemsNOTinConcernGroup <-oneResult_with_Y_flag$ParameterName[!(oneResult_with_Y_flag$ParameterName %in% chemsOfConcern)]


```


## Plot each Chemical of Concern {.tabset  .tabset-pills}


```{r PlotChemsOfConcern_Part1, include=FALSE}
# THIS weird few LINES is not really important except somehow by ploting, but not including (include=FALSE) this enables the rest to work?
fig <- ggplot(cars) + 
  geom_point(aes(speed, dist))
htmltools::tagList(ggplotly(fig))


### This next section is to figure how HOW MANY people HAD this compound and how many didn't
howManyHaveParameterName <- testResults.big %>%
  group_by(ParameterName) %>%
  summarise(non_zero_count = sum(Result != 0))
 

# Function to look up non_zero_count for a specific ParameterName
lookup_non_zero_count <- function(parameter_name, howManyHaveParameterName) {
  result <- howManyHaveParameterName %>%
    filter(ParameterName == parameter_name) %>%
    pull(non_zero_count)
  return(result)
}

# Example usage
#parameter_name_to_lookup <- "Trans-Nonachlor"  # Replace with your ParameterID
#non_zero_count_value <- lookup_non_zero_count(parameter_name_to_lookup, howManyHaveParameterName)
#print(non_zero_count_value)





```

We looked up all the chemicals to which you were exposed in a series of databases that flag chemicals of concern.  Please note both that (1) just because the chemical is concerning does not mean that the level at which you are exposed is an explicit health concern and also, importantly (2) that many chemicals are not tested for toxicity and so just because a chemical is not listed in a particular database does not imply it is safe.  We are comparing YOUR value on this chemical to OTHER people who also have this compound.  Others did not have this compound at all. 

Please click on each chemical name to see where your level of exposure compares to others in this study.




```{r PlotChemsOfConcern_Part2, results='asis',echo=FALSE,eval=TRUE}


###
### using variou web links to figure out...this is supposed to work... ineed to check this again...
###  THIS LOOKS GOOD:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops
######   THIS ONE GAVE ANSWER BELOW:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops


if (length(chemsOfConcern >= 1)) {
  for (i in 1:length(chemsOfConcern)) {
    chemOfConcern <- chemsOfConcern[i]
    #chemOfConcern <- chemsOfConcern[9]
    #chemOfConcern <- chemsOfConcern[1]
    
    
    #NOW make a table of all the users that had the one chemical of concern that we selected which our one user had
    testResults_ChemOfConcern <- testResults.big %>%
      filter(ParameterName == chemOfConcern) %>%
      select(SampleNumber, Result, ParameterName)
    
    
    if (nrow(testResults_ChemOfConcern) > 1) {
      cat("###", chemOfConcern, '{-}', '\n\n')
      
      print(htmltools::tagList(
        buildPlotlyViolin(chemOfConcern, testResults_ChemOfConcern)
      ))
      
      newMessage <- NULL
      
      newMessage <- paste (
        newMessage,
        " ",
        chemOfConcern,
        " was found on ",
        lookup_non_zero_count(chemOfConcern, howManyHaveParameterName),
        "out of the ",
        howManyWristbandsTested,
        "wristbands."
      )
      
      
      
      # newMessage <- paste(
      #   newMessage,
      #   chemOfConcern,
      #   ' was found in one or more online databases as being of some concern. '
      # )
      
      
      
      
      testInPROP65 <- oneResultCalifProp65Risk %>%
        filter(`Chemical Name` == chemOfConcern)
      if (nrow(testInPROP65) > 0) {
        PROP65_info <- testInPROP65$`Risk Type Per California Prop 65`
        newMessage <- paste (
          newMessage,
          " ",
          " This chemical is classified per California Proposition 65 (",
          " http://www.oehha.ca.gov/prop65.html ",
          " ) ",
          " with the risk type noted as: ",
          PROP65_info,
          "."
        )
      }
      
      ##### DELETED IARC cause Silent Spring suggested gettign rid
      # testInIARC <- oneResultIARCRisk %>%
      #   filter(`Chemical Name` == chemOfConcern)
      #  if (nrow(testInIARC) > 0) {
      #    IARC_info <- testInIARC$`Risk Type Per IARC`
      #    newMessage <- paste (newMessage,  " ",
      #                         " This chemical is classified by the International Agency for the Research on Cancer ",
      #                         " as a chemical of concern.  It is classified as: ",  IARC_info,".")
      #  }
      
      testInIRIS <- oneResultEpaIris %>%
        filter(`Chemical Name` == chemOfConcern)
      if (nrow(testInIRIS) > 0) {
        IRIS_info <- testInIRIS$`IRIS Summary Web Link`
        newMessage <- paste(
          newMessage,
          " ",
          "The Environmental Protection Agency has classified this chemical ",
          " as a chemical of concern.  You can find more information here: ",
          IRIS_info,
          " . "
        )
      }
      
      cat(newMessage)
      
      cat(' \n \n')
    }
  }
} else {
  testResults_ChemOfConcern <- testResults.big %>%
    filter(ParameterName == "NEVER MATCH") %>%
    select(SampleNumber, Result, ParameterName)
}


```












## Plot Remaining Chemicals {.tabset  .tabset-pills}


```{r PlotOtherChems_Part1, include=FALSE}
# THIS weird few LINES is not really important except somehow by ploting, but not including (include=FALSE) this enables the rest to work?
fig <- ggplot(cars) + 
  geom_point(aes(speed, dist))
htmltools::tagList(ggplotly(fig))


### This next section is to figure how HOW MANY people HAD this compound and how many didn't
howManyHaveParameterName <- testResults.big %>%
  group_by(ParameterName) %>%
  summarise(non_zero_count = sum(Result != 0))
 

# Function to look up non_zero_count for a specific ParameterName
lookup_non_zero_count <- function(parameter_name, howManyHaveParameterName) {
  result <- howManyHaveParameterName %>%
    filter(ParameterName == parameter_name) %>%
    pull(non_zero_count)
  return(result)
}

# Example usage
#parameter_name_to_lookup <- "Trans-Nonachlor"  # Replace with your ParameterID
#non_zero_count_value <- lookup_non_zero_count(parameter_name_to_lookup, howManyHaveParameterName)
#print(non_zero_count_value)


```


In addition to the chemicals specifically mentioned by the information above, there were other chemicals found on your wristband.  Please note both that  that many chemicals are not tested for toxicity and so just because a chemical is not listed in a particular database does not imply it is safe and it doesn't mean that it is of concern either. 

Please click on each chemical name to see where your level of exposure compares to others in this study.



```{r PlotOtherChems_Part2, results='asis',echo=FALSE,eval=TRUE}


###
### using variou web links to figure out...this is supposed to work... ineed to check this again...
###  THIS LOOKS GOOD:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops
######   THIS ONE GAVE ANSWER BELOW:  https://stackoverflow.com/questions/61906480/how-to-display-ggplotly-plots-with-dynamically-created-tabs-and-for-loops


if (length(chemsNOTinConcernGroup >= 1)) {
  for (i in 1:length(chemsNOTinConcernGroup)) {
    chemNOTinConcernGroup <- chemsNOTinConcernGroup[i]
    #chemOfConcern <- chemsOfConcern[9]
    #chemOfConcern <- chemsOfConcern[1]
    
    
    #NOW make a table of all the users that had the one chemical of concern that we selected which our one user had
    testResults_ChemNOTinConcern <- testResults.big %>%
      filter(ParameterName == chemNOTinConcernGroup) %>%
      select(SampleNumber, Result, ParameterName)
    
    
    if (nrow(testResults_ChemNOTinConcern) > 1) {
      cat("###", chemNOTinConcernGroup, '{-}', '\n\n')
      
      print(htmltools::tagList(
        buildPlotlyViolin(chemNOTinConcernGroup, testResults_ChemNOTinConcern)
      ))
      
      newMessage <- NULL
      
      newMessage <- paste (
        newMessage,
        " ",
        chemNOTinConcernGroup,
        " was found on ",
        lookup_non_zero_count(chemNOTinConcernGroup, howManyHaveParameterName),
        "out of the ",
        howManyWristbandsTested,
        "wristbands."
      )
      
      
      
      # newMessage <- paste(
      #   newMessage,
      #   chemOfConcern,
      #   ' was found in one or more online databases as being of some concern. '
      # )
      
      
      
      cat(newMessage)
      
      cat(' \n \n')
    }
  }
} else {
  testResults_ChemNOTinConcern <- testResults.big %>%
    filter(ParameterName == "NEVER MATCH") %>%
    select(SampleNumber, Result, ParameterName)
}


```





















## Individual: Chemical Info



```{r IndividualChemicalListWithClassification, child='IndividualChemicalListWithClassification_text.Rmd', eval = !HideClassificationInformation}
```


```{r IndividualChemicalListWithOutClassification, child='IndividualChemicalListWithOutClassification_text.Rmd', eval = HideClassificationInformation}
```



```{r IndividualClassificationShowingChemicalsAndAverages, child='IndividualClassificationShowingChemicalsAndAverages_text.Rmd', eval = !HideClassificationInformation}
```




```{r StatisticsOnAllChemicalsFound, child='StatisticsOnChemicalsFound.Rmd', eval = TRUE}
```




### Individual Percentage vs Maximum 


Another way to look at this is to wonder what percentage of a chemical a particular individual had compared to the maximum found for that chemical in any wristband in this project.   In other words, if wristband-A had 100 nano-grams per gram of wristband, and the maximum found in any individual was 1,000 nano-grams per gram wristband, then wristband-A had 10% of the maximum value found. The chart below shows the percentage of maximum found for this participant for each chemical.

`r if(nrow(testResults.big[testResults.big[, "Flag"] == "Y", ])>0){"Any wristbands where we detected a chemical, but could not quantify it, are suppressed from this chart below"}`


```{r chart_x5_perc_values, echo=FALSE, message=FALSE, fig.height=6,fig.cap="",dpi=150}
################BEGIN x5 Perc

perc_values <- testResults.big %>%   # NOTE using TR instead of testResults just cause then it has ParameterName
  filter(SampleNumber==subject) %>%
  select(ParameterName,norm_Result) 

 c<-ggplot(perc_values, aes(y=norm_Result ,factor(ParameterName))) +
    #geom_bar(stat="identity")+
    geom_bar(stat="identity", fill="blue", colour="black")+
    labs(x="All Chemicals Found for Anyone",
         y="Percent of Max value Found",
         title=paste("Your Percentage of Max Exposure\n",
                     "Found per Chemical\n",
                     "Subject = ",subject))
#c

axis.text.x.size <-6  # JUST changed to be a variable
if (howManyUniqueChemFoundAcrossAllWristbands < 60 ) axis.text.x.size <-10
c<- c+theme(axis.line=element_blank(),
            axis.ticks=element_blank(),
            axis.title.x=element_blank(),
           axis.text.x = element_text(angle = 90, vjust=.1,hjust=1,size=axis.text.x.size ),
#           axis.text.x = element_text(angle = 45,vjust=1,hjust=1,size=6 ),

            legend.position="none",
            panel.background=element_blank(),
            panel.border=element_blank(),
            panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),
            plot.background=element_blank())

#c <- c + scale_y_continuous(labels=percent, limits=c(0,1))
c <- c + scale_y_continuous(labels=percent)
c

rm(c,perc_values)

```

<br>
<br>

