---
output:
  html_document:
    fig_height: 14
    fig_width: 10
    self_contained: yes
    mode: selfcontained
    theme: cerulean
    toc: yes
    number_sections: yes
    df_print: paged
  pdf_document:
    toc: yes
  word_document:
    reference_docx: MyExposomeFormat_1527_v6.docx
---



[comment]: # (Weirdly I was using a backslash followed by     s  to be newline but changed to just backslash online by self for working in PDF as well as html and DOC)
[//1]: (comment HTML size was 7 height 6.5 width but gonna change)
[//2]: (comment THIS IS JUST A RANDOM COMMENT that stays HIDDEN could do toc:yes in html)
[//4]: ( --- AND I SHOULD update RStudio and all other components )
[//5]: ( KEY OBSERVATIONS about 10x values etc...  THIS IS NOW THE BASE VERSION FOR ALL RUNS.  )
[//6]: ( I SHOULD USE THIS VERSION FOR EVERY TEST and create new PAH / FLAME / etc from THIS or it won't work.)
[//7]: (comment2 NOTE that the config used to be: reference_docx: MyExposomeFormat_20.docx )
[//8]: ( no comment )
[//9]: (NOTE that we set the TITLE and AUTHOR in a section below the r code demarked with ---  to allow us to use variables to set title )

[//10]: (SHOULD ADD:  MesgV for when there are wristbands with NO compounds found)
[//11]: (  this was in top section:  pdf_document:      fig_height: 6.5      keep_tex: yes)






```{r loadLibraries, echo=FALSE, message=FALSE , include=FALSE,  fig.width=1, fig.height=1}
# COULD ADD THIS IN TITLE SECTION
#    date: "January 24, 2015"

#(empty line)
#[comment]: # (This actually is the most platform independent comment)

    
# PANDOC RELEASE NOTES:  http://pandoc.org/releases.html
# NOTE that I updated PANDOC separately from updating RSTUDIO by just copying files
# FROM the pandoc installation directory (C:\Users\Marc\AppData\Local\Pandoc)
# to the Rstudio Pandoc installation directory (C:\Program Files\RStudio\bin\pandoc)
# The following styles are used by pandoc: [paragraph] Normal, Compact, Title, Subtitle,
# Authors, Date, Abstract, Heading 1/2/3/4/5, Block Text,
# Definition Term, Definition, Bibliography, Body Text, Table Caption, Image Caption, Figure,
# FigureWithCaption; [character] Default Paragraph Font, Body Text Char, Verbatim Char,
# Footnote Reference, Hyperlink.

#word_document:
#    reference_docx: MyExposomeFormat_15_redo.docx
# NOTE that I make my own starting word doc by formatting certain things differently
####  I add header, add footer


#![](images/myExposomeLogo.png)




```


```{r loadPNG2, echo=FALSE, message=FALSE , fig.width=3, fig.height=1,fig.cap=""}

#{r loadPNG2, echo=FALSE, message=FALSE , fig.width=3, fig.height=2, fig.align="center"}


img <- readPNG("images/myExposomeLogo.png")
#grid.raster(img,just="centre")
grid.raster(img,name=NULL)
rm(img)


```


```{r loadUCSFPNG2, echo=FALSE, message=FALSE , fig.width=3, fig.height=1,fig.cap="", eval = FALSE}
#note CAN change eval=FAlSE to eval=UCSF2020Fixup

#TEST loading UCSF logo
img <- readPNG("images/UCSF_LOGO_bigger_2.png")
grid.raster(img,name=NULL)
rm(img)


```



 
```{r longanalysis, echo=FALSE, message=FALSE, include=FALSE}

# THIS FILE requires that an R source file be run first to
#     populate the environment.  
#     CAN BE DONE HERE or done before knit'ing this file

#
#Set all key variables.  Use the existance (or not) of "subject" to decide if they need to be loaded
if (!exists("subject")) {
    source("MyExp_set_key_variables.R")
}
# This test makes sure that if the SOURCE not yet run, we run it... but don't run it "again"
if (!exists("masterParam")) {  
  source(r_code)
} 
# This test makes sure that if the SOURCE not yet run, we run it... but don't run it "again"
if (!exists("buildMesgV")) {  
  source(support.functions.filename)
} 



#Create subset of testResults just to make clear what columns I'm using and why
# I'm grabbing just the ParameterName and normalized result 



#####NOTE NOTE NOTE THIS IS ONLY FOR THIS ONE RUN


### NOW FIX UP TEST RESULTS   
#####NOTE NOTE NOTE THIS IS ONLY FOR THIS ONE RUN
# if (FALSE) {  ### this werid section is JUST for the
#     #           FIRST flame run for EDF to fix values
#     #           from nanograms-per-wristband to ng/gram
#     fixUpResults<- read.table("./data/EDFSampleWts.csv",
#                               sep=","
#                               ,header=TRUE
#                               ,colClasses="character" # Import all as character
#                               ,comment.char = ""      # Don't allow use of "#" as comment in input
#                               , quote = "\""
#     )
#     fixUpResults$WBwt_g<-as.numeric(fixUpResults$WBwt_g)
# 
#     testResults2<-merge(fixUpResults,testResults,by="SampleNumber")
#     testResults2$Result<-testResults2$Result/testResults2$WBwt_g
#     testResults2$WBwt_g<-NULL
#     testResults<-testResults2
#     rm(testResults2,fixUpResults)
# }

## THE weird "r include problem Where if I optionally include a RMD file the EVAL value must be an actual value and not a compound value with lots of parts?
##  requires me to calculate this here to use in this RMD instead of using the compound expression
Not_weight_or_time_adjusted <- !(wristbands_weight_adjusted || wristbands_time_adjusted)

## THE weird "r include problem Where if I optionally include a RMD file the EVAL value must be an actual value and not a compound value with lots of parts?
##  requires me to calculate this here to use in this RMD instead of using the compound expression
NotHideClassificationInformation <- !HideClassificationInformation  # WEIRD negation always do to addres RMD call out "eval" function weirdness


```


---
title: "`r testName`"
author: "MyExposome, Inc."
---

```{r UseSetupGeneralInfoNotSubjectSpecific, echo=FALSE, message=FALSE, include=FALSE}

# !diagnostics suppress=masterParam,testResults.big,class_L,SubClassScores,ParameterID,classification



#Create text string with comma in it for the # of chemicals tested
howManyChemicalsTested <- format(nrow(masterParam),big.mark=",",scientific=FALSE)


# ONLY USE the non-zero rows in testResult to be sure we're only counting values >0
# Number of total non-zero results divided by # of WBs (that weren't all zero's)
averageNumberChemsFound <-  round(nrow(testResults.big[testResults.big$Result>0,])/
                                    length(unique(testResults.big[testResults.big$Result>0,]$SampleNumber)),
                                  1)



# Figure out TOTAL chemicals found ANYWHERE by Classification
CountChemicalsInEachClassification <- 
left_join(
    testResults.big %>% select(ParameterID) %>% distinct(),
    class_L,by="ParameterID") %>%
  mutate_if(is.factor, as.character) %>%
  group_by(classification) %>%
  dplyr::summarise(TotalFoundAnywhere=dplyr::n())
  


###### NOW set up class Compare variables
# This WAS in the GROUP COMPARE section but moved up to allow for summary paragrapha at top
# Set up the classCompare variable for later display
#THIS IS MARC new system to find ClassCompare instead of using ClassSub at all
# idea is to use SubClassScores which is a LONG table mapping class/sampleN/Aggregates
#     with another slice of that same table to product an integrated summary
#
#  First build with NO subject column... then add in SUBJECT column later in subject-specific-section
#
ClassCompareNoSubject <-   SubClassScores %>%
  group_by(classification) %>%
  summarize(max = max(aggScore), avg = round(mean(aggScore), 1)) %>% 
  mutate_if(is.factor, as.character) %>%  #Eliminate classification as a FACTOR so it sorts
  arrange(classification)  

if(! DoSpecificSubjectAnalysis) {   # IF WE do NOT want to do ANY subject SPECIFIC analysis In This Report
  subject="Never-Going-to-Match"
}

```



```{r UseSetupSubject, echo=FALSE, message=FALSE, include=FALSE, eval = DoSpecificSubjectAnalysis}

###############REMEMBER TO SET DATA FILE and SUBJECT TO MATCH

# Grab NON-zero rows which match our one subject
oneResult<-testResults.big[testResults.big$Result>0 & testResults.big$SampleNumber==subject,]
if (nrow(oneResult)>0){  # SO if we actually have anything in ONE RESULT THEN we're going to do something... otherwise just nonsense
  oneResult_with_Y_flag<-testResults.big[(testResults.big$Flag == "Y" | testResults.big$Result>0) & testResults.big$SampleNumber==subject,]
  #Sort Test Results by ParameterName
  oneResult <-arrange(oneResult,ParameterName)
  #Find PureSampleName of this sample
  pureSubjectName<-oneResult[1,'PureSampleName']
} else {
  oneResult_with_Y_flag<-oneResult
  pureSubjectName<-oneResult
}


#howManyChemsFoundThisWristband <- nrow(testResults[testResults$SampleNumber==subject,])
# ONLY USE the non-zero rows in testResult to be sure we're only counting values >0
howManyChemicalsFoundThisWristband<- nrow(oneResult_with_Y_flag)


### TO DO 
### TO DO   NEED to continue to fix Y flag stuf for Individual User
### TO DO 
### TO DO 

##Now try and find the median/min/max/sddev for each chemical found


#statSummary  


###### NOW set up class Compare variables
# This WAS in the GROUP COMPARE section but moved up to allow for summary paragrapha at top
# Set up the classCompare variable for later display
### idea is to smash together summarized data with just one column of data by using JOIN
####    LEFT join is key cause "any found category" is superset of "categories of this subject"
### so the two things we "join" are a summarization of the LONG classification of all subjects SCORES
#       with the scores for this individual subject
#ONCE we've joined those together then PIPE it over to select our columns/elim NA/arrange

ClassCompareSubject<- left_join(
  ClassCompareNoSubject %>% mutate_if(is.factor, as.character),
  SubClassScores[SubClassScores$SampleNumber==subject,] %>% mutate_if(is.factor, as.character),
  by="classification") %>%
  arrange(classification) %>%
  dplyr::rename(Participant=aggScore, Average=avg, maxFoundAnyOneBand=max) %>%
  select(classification,Participant,Average,maxFoundAnyOneBand) %>%
  replace_na(list(Participant=0)) 


### THIS SHOULD BE DEPRECATED... and we should use NoSubject and Subject versions
# ClassCompare<-as.data.frame(left_join(
#   SubClassScores %>%
#     group_by(classification) %>%
#     summarize(max=max(aggScore),avg=round(mean(aggScore),1)),
#   SubClassScores[SubClassScores$SampleNumber==subject,],
#   by="classification"
# ) %>%
#   select(classification,Participant=aggScore,Average=avg,maxFoundAnyOneBand=max) %>%
#   replace_na(list(Participant=0))) %>%
#   mutate_if(is.factor, as.character) %>%  #Eliminate classification as a FACTOR so it sorts
#   arrange(classification)

#ClassCompare <- ClassCompare %>%
  #mutate_if(is.factor, as.character) %>%
  #inner_join(CountChemicalsInEachClassification, by="classification")

#SET names of COLUMNS but use "Participant" for subject for NOW and change it SOON
#names(ClassCompare)<-c("classification","Participant","Average","Maximum Any Wristband")



```



```{r separateNoteToSelf, echo=FALSE, message=FALSE, include=FALSE}

##NOTES ON FUTURE "DO TO" with this RMD file
####  DONE SOMEWHAT  Add copyright and LIMITS OF LIABILITY to end of report.
#

```

# Introduction and Summary






`r if(testDoneFor != ""){ paste("**This test was done for:     ",testDoneFor, "**")   }`



```{r GroupAnalysisIntro, child="./GroupAnalysisIntro_text.Rmd", eval = DoGroupAnalysisOnly}

```





```{r SpecificSubjectAnalysisIntro, eval = DoSpecificSubjectAnalysis , child="./SpecificSubjectAnalysisIntro_text_SBIR.Rmd"}
```





```{r  IRiS_Prop65_IARC_Group_Results, results='asis', echo=FALSE, message=FALSE}

#Calculate epa IRIS results but display it later

# FOR ALL CHEMICALS FOUND on ANY wristband 
# Figure how WHAT the hits were on each database of bad chems
# and figure out how-many hits

#FOR EPAIRIS
#Find all hits agaisnt this DB found in any wristband
EPAirisHits <- testResults.big %>%
  mutate(Result = case_when (Flag=="Y" ~ 100,
                             TRUE ~ Result)) %>%  # IF we have a Y flag on an item set the ZERO value to 100
  filter(Result>0) %>%
  select(ParameterID, ParameterName) %>%
  distinct() %>%
  inner_join(epaIris, by = "ParameterID") %>%
  select(ParameterName, IRIS_Summary) %>%
  dplyr::rename("Chemical Name" = ParameterName, "IRIS Summary Web Link" = IRIS_Summary)

#FOR EPA IRIS count'm up
countEPAiristHits<-nrow( EPAirisHits )
    
#--------------------------

#calculate PROP 65 results, print later

#Find all hits agaisnt this DB found in any wristband
CalifProp65Hits <- testResults.big %>%
  mutate(Result = case_when (Flag=="Y" ~ 100,
                             TRUE ~ Result)) %>%  # IF we have a Y flag on an item set the ZERO value to 100
  filter(Result>0) %>%
  select(ParameterID, ParameterName) %>%
  distinct() %>%
  inner_join(riskCalifProp65, by = "ParameterID") %>%
  select(ParameterName, toxicityType) %>%
  dplyr::rename("Chemical Name" = ParameterName, "Risk Type Per California Prop 65" = toxicityType)


#FOR Prop 65 count'm up
countCalifProp65Hits<-nrow( CalifProp65Hits )


#calculate IARC results, print later

#Find all hits agaisnt this DB found in any wristband
IARCHits <- testResults.big %>%
  mutate(Result = case_when (Flag=="Y" ~ 100,
                             TRUE ~ Result)) %>%  # IF we have a Y flag on an item set the ZERO value to 100
  filter(Result>0) %>%
  select(ParameterID, ParameterName) %>%
  distinct() %>%
  inner_join(IARCRisk, by = "ParameterID") %>%
  select(ParameterName, IARC_Classification) %>%
  dplyr::rename("Chemical Name" = ParameterName, "Risk Type Per IARC" = IARC_Classification)


#FOR Prop 65 count'm up
countIARCHits<- nrow( IARCHits )









```



## List of Key Observations

Chemicals make up the material backbone of products
in commerce—from couches and carpets to clothes and
cleaning products. While chemicals serve an important
role in our economy, they also end up in our environment—
in our water, land, and air—and our bodies.
Some of these chemicals are hazardous and exposure to
them—whether through environmental releases, workplace
exposures, or use of products—can lead to health
problems such as asthma, learning disabilities, and
cancer. Unfortunately, we have insufficient information
about exactly which chemicals individuals are exposed
to and in what amounts. Without this information it is
challenging for individuals to determine how best to
reduce their exposure to harmful chemicals, or for government
agencies, companies, health professionals, and
others to develop effective policies and interventions to
protect public health from harmful chemicals.  Wristbands are intended to address this information void.


**IMPORTANT NOTE:**  We have listed, where data was available, information regarding some known health implications of exposures to some of the compounds found in the wristbands.  **PLEASE NOTE** that we are NOT saying there is anything you need to be concerned about because we are **NOT** comparing the **LEVEL** of compound found in the wristbands to the level necessary to create any health concerns.  This project is designed to measure individual exposures to certain chemicals in your environment. It is not attempting to explain the relationship between an exposure and a health outcome.
The measurement of an environmental chemical in a person’s wristband does not mean, by itself, that the chemical causes harm or disease. Advances in analytical methods allow us to measure low levels of environmental chemicals, but separate studies of varying exposure levels and health effects are needed to determine whether levels result in disease.

This project is explicitly **NOT** medical research and you should not use the results in that way.   Having said that, there are indeed some compounds that are interesting to know about.  Some people decide to limit their exposures through altered purchases and behaviors although, in our society, that is sometimes not easy.  **One of the great challenges is that many chemical compounds are not studied for real world exposure and so for most compounds there are really no clear guidelines.**

The rest of this document provides more details and context for the below summary.  See the section "List of Chemicals found, showing Classifications" to understand how any of the compounds listed below are commonly used and classified.


```{r BuildMessageString, results='asis', echo=FALSE, message=FALSE}

#COMMENTS BY MARC:  We are building a MESSAGE STRING = "mesg.v"
# and we will keep concatenating onto "mesg.v" with whatever new information we can 
# 

# Initialize mesg  to NULL
mesg.v <- NULL  # and use a vector

### INDIVIDUAL RESULTS COME FIRST:
####### add line to indicate start of INDIVIDUAL results

if (DoSpecificSubjectAnalysis) {
  mesg.v <- addMesg(mesg.v,1," ","**INDIVIDUAL RESULTS**")
  # Add things to mesg vector using a function call to support functions
  mesg.v <- buildMesgVIndividual  (testResults.big, 
                                   mesg.v,
                                   subject, 
                                   SubClassScores, 
                                   results_W,
                                   numEPAirisFound,
                                   numCalProp65Found,
                                   numIARCRiskFound)
}

### GROUP RESULTS COME AFTER INDIVIDUAL RESULTS
####### add line to indicate start of GROUP results
mesg.v <- addMesg(mesg.v,1," ","**GROUP RESULTS**")
# Add things to mesg vector using a function call to support functions
mesg.v <- buildMesgVGroup  (testResults.big, 
                            mesg.v, 
                            SubClassScores, 
                            results_W,
                            countEPAiristHits,
                            countCalifProp65Hits,
                            countIARCHits)

  
pandoc.list(mesg.v)  ## This prints the Individual Band (if doing) and Group bands report(s)
rm(mesg.v)





if (DoSpecificSubjectAnalysis) {
  rm(numIARCRiskFound,numCalProp65Found,numEPAirisFound )
}

#rm(buildMesgV) # can't really remove this cause I'm using this as a flag to see if need to reload

```


`r if(nrow(testResults.big[testResults.big[, "Flag"] == "Y", ]) >0){
                            paste("**IMPORTANT NOTE:     ",length(unique(testResults.big[testResults.big[, "Flag"] == "Y", ]$ParameterName)),
                            "of the tested compounds impacting ",
                            length(unique(testResults.big[testResults.big[, "Flag"] == "Y", ]$SampleNumber)),
                            "wristbands could not be fully quantified.**")
                            }`
`r if(nrow(testResults.big[testResults.big[, "Flag"] == "Y", ]) >0){
                            paste("\n Due instrument challenges some chemicals were present but could not be quantified.",
                              "For reporting below, where numbers are needed, these specific results are counted as though",
                              "they detected zero because we don't have an actual number to use in this report",
                              "but we can report that these compounds were definitely detected on these wristbands")
                            }`
                            



```{r BuildCaveatMessageString, results='asis', echo=FALSE, message=FALSE}

### IMPORTANT CAVEATS That MUST be added
### NOTE:  at the moment, the only caveat is the "Y" caveat

### HERE IS SOME R error with below code, generating a WARNING for now... no idea why
# 
# Warning message:
# The `i` argument of ``[`()` can't be a matrix as of tibble 3.0.0.
# Convert to a vector.
# This warning is displayed once every 8 hours.
# ## FIXED FIXED FIXED

if (any(testResults.big[, "Flag"] == "Y")) {   # testing if we have any "Y"
  mesg.v2 <-NULL
  # if ( length(unique(testResultsWith_Y_Flag$SampleNumber)) == 1) {
  #   mesg.v2 <- addMesg(mesg.v2,1," ",
  #                     paste("**IMPORTANT NOTE:  ",
  #                           length(unique(testResultsWith_Y_Flag$ParameterName)),
  #                           "of the compounds impacting ",
  #                           length(unique(testResultsWith_Y_Flag$SampleNumber)),
  #                           "wristband could not be fully quantified**"))
  # } else {
  #   mesg.v2 <- addMesg(mesg.v2,1," ",
  #                     paste("**IMPORTANT NOTE:  ",
  #                           length(unique(testResultsWith_Y_Flag$ParameterName)),
  #                           "of the compounds impacting ",
  #                           length(unique(testResultsWith_Y_Flag$SampleNumber)),
  #                           "wristbands could not be fully quantified**"))
  # }
  # mesg.v2 <- addMesg(mesg.v2,1," ","***   Due instrument challenges some chemicals were present but could not be quantified")
  # mesg.v2 <- addMesg(mesg.v2,1," ","***   For reporting below, where numbers are needed, these specific results are counted as though ")
  # mesg.v2 <- addMesg(mesg.v2,1," ","***       they detected ZERO because we don't have an actual number to use in this report")
  # mesg.v2 <- addMesg(mesg.v2,1," ","***       but we can report that these compounds were definitely detected")
  testResultsWith_Y_Flag<-arrange(testResults.big[testResults.big[, "Flag"] == "Y", ], ParameterName)
  for(i in 1:nrow(testResultsWith_Y_Flag)) {
    row <- testResultsWith_Y_Flag[i,]
    txt <-paste(row$ParameterName, "was detected on wristband:", row$SampleNumber)
    mesg.v2 <- cbind(mesg.v2, txt)
  }
  pandoc.list(mesg.v2)  ## This prints the Individual Band (if doing) and Group bands report(s)
  rm(mesg.v2,testResultsWith_Y_Flag)
}

#rm(buildMesgV) # can't really remove this cause I'm using this as a flag to see if need to reload

```



******




```{r CompoundClassification, child='CompoundClassification_text.Rmd', eval = NotHideClassificationInformation}
```




```{r IndividualResultsAnalysis, child='IndividualResultsAnalysis_text.Rmd', eval = DoSpecificSubjectAnalysis}
```


# Group Comparison Results `r tabsetting`



As previously stated, the average number of chemicals found was **`r round(averageNumberChemsFound,1)`**.  All wristbands were tested for  **`r howManyChemicalsTested`** chemicals.  In this section, we will go over many of the same categories as the section above but show you wristband results from the entire group instead of just your wristband.



```{r GroupChemicalListWithClassification, child='GroupChemicalListWithClassification_text.Rmd', eval = NotHideClassificationInformation}
```


```{r GroupChemicalListWithOutClassification, child='GroupChemicalListWithOutClassification_text.Rmd', eval = HideClassificationInformation}
```


```{r AirConcentrationNioshOsha, child='airConcentrationOutput.Rmd', eval = doAIRplusNioshOSHAreporting}
```



```{r GroupClassificationAnyWristband, child='GroupClassificationAnyWristband_text.Rmd', eval = NotHideClassificationInformation}
```


```{r GroupDatabaseLookupReporting, child='GroupDatabaseLookupIARC_Prop65_IRIS.Rmd', eval = DoGroupDatabaseLookupReporting}
```




&nbsp;





## Statistics on Chemicals Found

One important way to look at the data is, for each chemical, what was the minimum/maximum/mean/median value found, how many wristbands was it found on, and the standard deviation of all the values found.  




```{r print_not_time_or_weight_adjust, results="asis", echo=FALSE, eval=Not_weight_or_time_adjusted}

cat("The data is the raw nanograms found in each wristband. " ,sep="")

```







```{r print_weight_only_adjust1, results="asis", echo=FALSE, eval=wristbands_weight_adjusted}

cat("The data is the raw nanograms found in each gram of wristband. " ,sep="")

```



```{r print_loreal_4x, results="asis", echo=FALSE, eval=wristbands_time_adjusted_one_week_not_weight}

cat("The data is the raw nanograms found normalized to time-adjust the values as though the wristband were worn for exactly one week (the most common time worn for all projects). ",sep="")

```



```{r print_loreal_4x3, results="asis", echo=FALSE, eval=wristbands_week_and_weight_adjusted}

cat("The data is the raw nanograms found in each gram of wristband normalized " ,
      "to time-adjust the values as though the wristband were worn for exactly one week. ",
      "In other words, the raw data was adjusted by the time worn and the size ",
      "of the wristbands between participants to make data as comparable as ",
      "possible before general statistics were performed on each chemical.",
      sep="")

```


```{r print_loreal_4x2, results="asis", echo=FALSE, eval=wristbands_time_adjusted_one_day}

cat("The data is the raw nanograms found normalized to time-adjust the values as though the wristband were worn for exactly one day. ")

```




Values below the limit of detection, or values that could not be quantified, are not included in the statistical analyses and are listed as zeros. 


That information is displayed below: 
&nbsp;


```{r StatSummary, results='asis', echo=FALSE, eval=TRUE, message=FALSE}

### Had error where i was renaming columns for 2nd time so it didn't work.  
### Need to test if column names wrong and rename only if wrong:

if("Chemical_Name" %in% colnames(statSummary))
{
  statSummary <- statSummary %>%  dplyr::rename("Chemical Name"=Chemical_Name)
}

if("Standard_Deviation" %in% colnames(statSummary))
{
  statSummary <- statSummary %>%  dplyr::rename( "Standard Deviation"=Standard_Deviation)
}
#statSummary


if (HideIndividualization) {
  panderOptions("big.mark", ",") # THIS line ADDS a COMMA in MOST of the numbers (not all... )

  pandoc.table(as.data.frame(statSummary)
             ,caption="Statistical Report on all Chemicals on all Wristbands"
             ,justify=c("right","right","right","right","right","right","right")
             ,emphasis.rownames=TRUE
             ,split.table = Inf
             )
} else {

### IF I WANTED TO DO statSummaryand include e ONE user's chemical results in a list showing all chemicals found
# Then:  make the oneResultStatSummary and other pandoc table below...
  oneResultStatSummary<- oneResult %>%
    select(ParameterName,Result) %>%
    rename("Chemical Name"=ParameterName) %>%
    right_join(statSummary,by="Chemical Name") %>%
    replace_na(list(Result = 0)) %>%
    rename(!!paste(subject,"Result",sep=" "):= Result)

    panderOptions("big.mark", ",") # THIS line ADDS a COMMA in MOST of the numbers (not all... )
  
  pandoc.table(as.data.frame(oneResultStatSummary)
               ,caption=paste("Statistical Report on all Chemicals on just",subject,"wristband",sep=" ")
               ,justify=c("right","right","right","right","right","right","right","right")
               ,emphasis.rownames=TRUE
               ,split.table = Inf
               )
}




### IF I WANTED TO DO statSummary JUST for the ONE user's chemicals
# Then:  make the oneResultStatSummary and other pandoc table below.... NORMALLY COMMENT THIS OUT
# oneResultStatSummary<- oneResult %>% 
#   select(ParameterName,Result) %>% 
#   rename(!!paste(subject,"Result",sep=" "):= Result) %>%
#   rename("Chemical Name"=ParameterName) %>% 
#   left_join(statSummary,by="Chemical Name")
# panderOptions("big.mark", ",") # THIS line ADDS a COMMA in MOST of the numbers (not all... )
# pandoc.table(as.data.frame(oneResultStatSummary)
#              ,caption=paste("Statistical Report on all Chemicals on just",subject,"wristband",sep=" ")
#              ,justify=c("right","right","right","right","right","right","right","right")
#              ,emphasis.rownames=TRUE
#              ,split.table = Inf
#              )

```
<br>
<br>


## Chemicals Found as % of Participants

Here are all the chemicals found on any wristband.  If every participants wristband contained a given chemical that chemical will show height as 100%. If only one person had a chemical it will be the shortest possible bar. The dashed red line is drawn at 50% to more easily discern chemicals that were found in most of the samples.

`r if(DoSpecificSubjectAnalysis){"If the chemical was found on your wristband then that bar is colored blue.  If the chemical was found on at least one other participant, but not on your wristband, the bar is colored grey.  For example, if you see a high percentage of blue bars up near 100% then your sample has a high overlap with the rest of the study group.  If most of the blue bars are down below 50% then your sample does not overlap as much with the rest of the group."}`


```{r Chart_bar_Percentages, echo=FALSE, message=FALSE,fig.height=6, fig.cap="", dpi=300}
###THIS IS a better version of above, eliminating SQLDF
#     it gives us a table with 2 columns, ALL FOUND CHEMS and % wb w/ chem
#### but now I'm adding a 3rd column, subHas, which will be true if OUR subject has THAT value
# and I'm setting this to Z instead of X cause we've made all that nonsense not-needed


### THIS IS PLAY AREA BELOW TO SEE WHAT IS HAPPENING:


#### END PLAY AREA

## OLDER VERSION before I added in making sure if FLAG=Y we also report that
# z<-testResults.big[testResults.big$Result>0,] %>%                      # Pipe all non zero results
#   select(ParameterName,SampleNumber)%>%                        # select only 2 columns
#   group_by(ParameterName) %>%                                  # Group by one column
#   summarise(PercentSubjects=round(n()/howManyWristbandsTested,2),             # COUNT how many values, and make % 
#             subjectHasChem=as.numeric(any(SampleNumber==subject)))     # Add 1 if our subject has, 0 otherwise
# 

## NEWER 3/7/2019 version that make sure to count any FLAG=Y as having a value
z<-testResults.big %>%                      # Pipe all non zero results
  mutate(Result = case_when (Flag=="Y" ~ 100,
                             TRUE ~ Result)) %>%  # IF we have a Y flag on an item set the ZERO value to 100
  filter(Result>0) %>%
  select(ParameterName,SampleNumber)%>%                        # select only 2 columns
  group_by(ParameterName) %>%                                  # Group by one column
  summarise(PercentSubjects=round(dplyr::n()/howManyWristbandsTested,2),             # COUNT how many values, and make %
            subjectHasChem=as.numeric(any(SampleNumber==subject))) 




c <- ggplot(z, aes(y=PercentSubjects,
                   factor(ParameterName),
                   fill=factor(subjectHasChem)))
c <- c+ geom_bar(stat="identity")

#CLEANUP some extra things
rm(z)

 #SET FONT SIZE for X axis Labels
 if (howManyUniqueChemFoundAcrossAllWristbands<=60) {
   x_axis_font_size = 12
 } else if (howManyWristbandsTested <= 120) {
   x_axis_font_size = 6
 } else {
   x_axis_font_size = 4
}

c<- c+theme(axis.line=element_blank(),
           axis.ticks=element_blank(),
           axis.title.x=element_blank(),
           #axis.text.x = element_text(angle = 70,hjust = 1,size=4 ),
           axis.text.x = element_text(angle = 70,hjust = 1,size=x_axis_font_size),
           legend.position="none",
           panel.background=element_blank(),
           panel.border=element_blank(),
           panel.grid.major=element_blank(),
           panel.grid.minor=element_blank(),
           plot.background=element_blank())
if (HideIndividualization) {
  c <- c + scale_fill_manual(values = c("blue","blue"))
} else {
  c <- c + scale_fill_manual(values = c("grey","blue"))
}

c <- c  +labs(x="All Chemicals Found", y="Percentage of Participants with Chemical",
               title="All Chemicals Found")

c <- c + geom_hline(yintercept=.50, linetype="dashed", color = "red")  # ADD horizontal red line at 50% 

c <- c + scale_y_continuous(labels=percent) 
c 

rm(c)

```



```{r GroupClassificationAtLeastOne, child='GroupClassificationAtLeastOne_text.Rmd', eval = NotHideClassificationInformation}
```


```{r GroupClassificationEveryWristband, child='GroupClassificationEveryWristband_text.Rmd', eval = NotHideClassificationInformation}
```



## Chart of All Tested-for Chemicals
As a more detailed breakdown, we can get an overview of the test for all the  chemicals found in every tested wristband.  The chart below has a horizontal line for every tested chemical.  The blank space shows that most of the chemicals don't show up in any of the tested wristbands but, once a chemical is found in one of the wristbands it is typically found in others as well.  This can be seen below by observing how frequently the horizontal light-blue lines are aligned.   The diagram after this one provides more details about the specific chemicals found, the purpose of this diagram is to show an overview.


```{r allChemChart, echo=FALSE, message=FALSE, fig.height=9, fig.cap=""}

#Set Up basic all chemical GGPLOT

#THIS commented version does NOT include using Y value of FLAG to fill in more 1's
#Need to create version of data with EVERY chemical filling in zeros
# place_holder <- masterParam %>% 
#   merge(testResults.big%>%select(-ParameterName),by="ParameterID",all.x=TRUE) %>%
#   select(ParameterName,Participant=SampleNumber,valueX=Result) %>%
#   mutate(value=as.numeric(valueX>0)) %>%
#   select(Participant,ParameterName,value) %>%
#   spread(Participant,value,fill=0) 
# 
#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...
#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...
#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...
#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...#DEBUGGING BELOW...

# insideMerge<-masterParam %>%
#   merge(testResults.big%>%select(-ParameterName),by="ParameterID",all.x=TRUE) %>%
#   mutate(Result=case_when(Flag =="Y" ~ 100,   # IF flag is Y then pretend Result has some VALUE
#                      TRUE ~ Result))
# 
# place_holderx <- masterParam %>%
#   merge(testResults.big%>%select(-ParameterName),by="ParameterID",all.x=TRUE) %>%
#   mutate(Result=case_when(Flag =="Y" ~ 100,   # IF flag is Y then pretend Result has some VALUE
#                      TRUE ~ Result)) %>%
#   select(ParameterName,Participant=SampleNumber,valueX=Result)# %>%      # SOMEHOW it is NOT UNIQUE down HERE, WHY????
#   #mutate(value=as.numeric(valueX>0)) %>%
#   #select(Participant,ParameterName,value)# %>%   spread(Participant,value,fill=0)
# 
# 
# #STILL DEBUGGING:   adding a UNIQUE which seems weird...Need to create version of data with EVERY chemical filling in zeros
# place_holder <- masterParam %>%
#   merge(testResults.big%>%select(-ParameterName),by="ParameterID",all.x=TRUE) %>%
#   mutate(Result=case_when(Flag =="Y" ~ 100,   # IF flag is Y then pretend Result has some VALUE
#                      TRUE ~ Result)) %>%
#   select(ParameterName,Participant=SampleNumber,valueX=Result) %>%
#   mutate(value=as.numeric(valueX>0)) %>%
#   select(Participant,ParameterName,value) %>%
#   unique() %>%   #####   NEEDED TO ADD UNIQUE and that fixed things... BUT WHY?  I got steven to fix the raw DATA and now I'm commenting out this debugging
#   spread(Participant,value,fill=0)
# 
# 
# #mtcars %>% filter(duplicated(.[c("carb", "cyl")])
# place_holder %>% filter ( duplicated(.[c("ParameterName","Participant","valueX"                   )]))
# 
# place_holder %>% filter ( duplicated(ParameterName,Participant,valueX))     
#  nrow((place_holder))
#  nrow(unique(place_holder))
# write.csv(place_holder, file = "data/place_holder.csv", row.names=FALSE)   


#DEBUGGING END   (NOTE still in debugging mode!!!)


#Need to create version of data with EVERY chemical filling in zeros
place_holder <- masterParam %>%
  merge(testResults.big%>%select(-ParameterName),by="ParameterID",all.x=TRUE) %>%
  mutate(Result=case_when(Flag =="Y" ~ 100,   # IF flag is Y then pretend Result has some VALUE
                     TRUE ~ Result)) %>%
  select(ParameterName,Participant=SampleNumber,valueX=Result) %>%
  mutate(value=as.numeric(valueX>0)) %>%
  select(Participant,ParameterName,value) %>%
  spread(Participant,value,fill=0)



#If we get bogus column, we'll delete it
place_holder$"<NA>" <- NULL

#Now return this to a LONG table instead of WIDE but, this time, with EVERY chemical
place_holder <- place_holder %>%
  gather(key="Participant",value="value",-ParameterName)

allChemChart<-  ggplot(place_holder, 
                       aes(y=factor(ParameterName,
                                    levels=sort(unique(ParameterName),
                                                decreasing=TRUE)),
                           x=Participant,fill=value)
) +  geom_tile() 

#allChemChart
#SET FONT SIZE for X axis Labels
if (howManyWristbandsTested<=60) {
  x_axis_font_size = 12
} else if (howManyWristbandsTested <= 120) {
  x_axis_font_size = 6
} else {
  x_axis_font_size = 4
}
# Add THEME elements, basically hiding most things
allChemChart<-allChemChart + theme(legend.position="none", 
                                   axis.text.y=element_blank(),
                                   #axis.ticks.y=element_blank(), #SHOW TICKS by commenting this out
                                   #axis.text.x = element_text(angle = 45, hjust = 1),
                                   axis.text.x = element_text(angle = 70,hjust = 1,size=x_axis_font_size ),
                                   
                                   #axis.text.x = element_blank(),
                                   axis.line=element_blank()
)  
# SET color elements to plot
allChemChart<-allChemChart + scale_fill_gradient(low = "white",high = "steelblue")   #### This is causing problems
#allChemChart<-allChemChart + scale_y_discrete(breaks=seq(1,10,100))

#  allChemChart<-allChemChart + scale_y_discrete(breaks=function(n) 
#  c(0
#    , floor(max(as.integer(factor(n)))/500)
#    , max(as.integer(factor(n))))
#  ) 


# Set X, Y and top labels/legends
allChemChart<- allChemChart + 
  labs(x="Participants", 
       y=paste("Chemicals  (Compressed View of All ", howManyChemicalsTested," tested chemicals)",sep=""), 
       title="All Chemicals Tested")

#Now display the chart
allChemChart 


```

<br>
<br>


## Chart of all Found Chemicals

To allow us to look more carefully at the blue lines, we'll eliminate from the chart all those lines which represent chemicals found in none of the wristbands in this sample set.  We'll also eliminate any of the wristbands that didn't  have ANY chemicals found.   The chart below has a horizontal line for every tested chemical that was seen in at least one wristband. 

`r if(DoSpecificSubjectAnalysis){"Your wristband is differentiated by color."}`



```{r activeChemChart, echo=FALSE, message=FALSE, fig.height=8,fig.cap=""}

options(height = 8)  #this is redundant with the heading setting I THINK but so what

# Make copy of r_long so we don't change anything important here:

## Playing Around:

## end playing around


### STUFF BELOW IS OLD before I added back in colorizing from FLAG
# r_long_tmp<-testResults.big[testResults.big$Result>0,] %>%
#   rename(value=Result,Participant=SampleNumber)
# #Set all the values of r_long that are > 1 to be ONE so that I can later change the color...
# r_long_tmp[ (r_long_tmp$value>0)  , ]$value <- 1   # This will set all results >=1 to be one
# #Set all the values of r_long that have Y FLAG to be ONE so that I can later change the color...
# r_long_tmp[ (r_long_tmp$Flag == "Y")  , ]$value <- 1   # This will set all results >=1 to be one
# #r_long_tmp[ r_long_tmp$value>=1  , ]$value  #<-1   # This will set all results >=1 to be one

### NOW I setup r_long_tmp correctly including noting that FLAG=Y does mean this wristband was counted.
r_long_tmp<-testResults.big %>%
  dplyr::rename(value=Result,Participant=SampleNumber)
#Set all the values of r_long that are > 1 to be ONE so that I can later change the color...
## FIRST way of setting this, below, can cause errors if there is nothing to set.  2nd way doesn't
#r_long_tmp[ (r_long_tmp$value>0)  , ]$value <- 1   # This will set all results >=0 to be one
r_long_tmp[ (r_long_tmp$value>0)  , "value"] <- 1   # This will set all results >=0 to be one




#Set all the values of r_long that have Y FLAG to be ONE so that I can later change the color...
# FIRST way of setting this, below, can cause errors if there is nothing to set.  2nd way doesn't
#r_long_tmp[ (r_long_tmp$Flag == "Y")  , ]$value <- 1   # This will set all results >=1 to be one
r_long_tmp[ (r_long_tmp$Flag == "Y")  ,"value" ] <- 1   # This will set all results >=1 to be one

#Get rid of all rows that have NO values set
r_long_tmp <- r_long_tmp %>% filter(value>0)


#Set the subject value COLUMN in the chart to be a different COLOR
if (!HideIndividualization) {
  #r_long_tmp[ (r_long_tmp$Participant==subject) & (r_long_tmp$value==1)  , ]$value<-100   # This will turn RED
  r_long_tmp[ (r_long_tmp$Participant==subject) & (r_long_tmp$value==1)  , "value"]<-100   # This will turn RED  
}

#r_long[ (r_long$Participant=="A150206") & (r_long$value==100)  , ]$value<-1
#r_long[ (r_long$Participant=="A150206") & (r_long$value==100)  , ]$value

#highlightColor<-"#d7191c"
#highlightColor<-"hotpink1"
highlightColor<-"maroon2"

#  NOTE NOTE NOTE:  The color ramp palette below had a (3) instead of a (2) and so I changed it but vaguely remember this causes ERROR sometimes??  11/2016
if (HideIndividualization) {   #HideIndividualization is so that the charts can be used without referencing one WB
  colors <- colorRampPalette(c("#2c7bb6", "#2c7bb6"))(2)   #Set  colors as light blue and light blue
} else {
colors <- colorRampPalette(c("#2c7bb6", highlightColor))(2)   #Set two colors as light blue and RED--2 means find TWO colors in that range
}


#Setup basic chart
activeChemChart<-ggplot(r_long_tmp[r_long_tmp$value>0 ,],
                        aes(y=factor(ParameterName,
                                     levels=sort(unique(ParameterName),
                                                 decreasing=TRUE)),
                            x=Participant,fill=factor(value)),
                        ylab=NULL,
                        xlab=NULL
) + geom_tile() + scale_fill_manual(values=colors)

# Make a list of all black repeated the number of times we have subjects in the experiment
columnColors = rep("black",howManyWristbandsTested)
# Change ONE item on the list to be the color we're going to use for highlighting
columnColors[which (colnames(results_W)==subject)]<-highlightColor  #"#d7191c"

#SET FONT SIZE for X axis Labels
if (howManyWristbandsTested<=60) {
  x_axis_font_size = 12
} else if (howManyWristbandsTested <= 120) {
  x_axis_font_size = 6
} else {
  x_axis_font_size = 4
}

#SET FONT SIZE for Y axis Labels
if (howManyUniqueChemFoundAcrossAllWristbands<=60) {
  y_axis_font_size = 10
} else if (howManyUniqueChemFoundAcrossAllWristbands <= 90) {
  y_axis_font_size = 8
} else if (howManyUniqueChemFoundAcrossAllWristbands <= 120) {
  y_axis_font_size = 6
} else {
  y_axis_font_size = 4
}




#hide many items using element_blank() plus set other THEME things
##NOTE that I got an ERROR about 
#   ## Warning: Vectorized input to `element_text()` is not officially supported.
#   # Results may be unexpected or may change in future versions of ggplot2.
#SO i wrapped this in suppressMessagse and suppressWarnings... not sure this was wise

activeChemChart <- activeChemChart + theme(axis.line=element_blank(),
                                           axis.ticks=element_blank(),
                                           axis.title.y=element_blank(),
                                           axis.text.x = suppressMessages(suppressWarnings( element_text(angle = 70,  ##HERE is where i suppress errors
                                                                      hjust = 1, 
                                                                      colour=columnColors,
                                                                      size=x_axis_font_size)#or leave blank? (Normally 6, SET To 4 if MANY wristbands)
                                                                      )
                                                                      ),  
                                           axis.text.y = element_text( colour="black",size=y_axis_font_size), 
                                           legend.position="none",
                                           panel.background=element_blank(),
                                           panel.border=element_blank(),
                                           panel.grid.major=element_blank(),
                                           panel.grid.minor=element_blank(),
                                           plot.background=element_blank())

#Setup labels
activeChemChart<-activeChemChart     +labs(x="Participants",
                                           
                                           y="Chemicals",
                                           title="Chemicals Found")

#Set the Y label axis text to be dark red and smaller font so it fits
#activeChemChart <- activeChemChart +   theme(axis.title.y = element_text(face="bold", colour="#990000", size=20))
#activeChemChart <- activeChemChart + theme(axis.text.y = element_text( colour="#990000")) 
#activeChemChart <- activeChemChart + theme(axis.text.y = element_text( colour="black")) 
activeChemChart <- activeChemChart + theme(axis.text.y = element_text( colour="black",size=y_axis_font_size)) 

#Show the chart
activeChemChart

rm(r_long_tmp,activeChemChart,columnColors,colors,highlightColor)

```

<br>
<br>
<br>
<br>
<!-- \newpage -->


## Heat Map: "relatively how much" of each chemical

The following chart shows how your wristband compares to other wristbands in this group in terms of how many, and how much, of each chemical was found.  We eliminate from the chart all those lines which represent chemicals found in none of the wristbands in this sample set showing only chemicals that at least one person did show in his/her wristband.

`r if(DoSpecificSubjectAnalysis){"Your wristband name is highlighted in green on the bottom row of the chart."}`


NOTE:  It is important to understand this chart properly.  A more highly saturated red color means MORE of the chemical compound was found while a lighter color means relatively less was found. A white, or blank, means that none of that compound was detected in your wristband.   Having said that, please do not try to compare BETWEEN ROWS.  Mathematically speaking the colors have no meaning when compared between rows due to different rates of uptake of each chemical into a wristband.  In other words, just compare the colors across a given row, not between rows.

To create this chart, we normalized within each row based on the maximum value for that chemical in any wristband. We then  separate the values into 5 groups and color coding all items within each group.  It is useful to remember that the groups are relative to each row separately and independently.  The five groups are:

+ Top 25%
+ 3rd 25%
+ 2nd 25%
+ Bottom 25%
+ None Found


In the image below the black squares highlight which wristband had the maximum value for each chemical.
`r if(DoSpecificSubjectAnalysis){"The green dots indicate your wristband."}`

`r if(nrow(testResults.big[testResults.big[, "Flag"] == "Y", ])>0){"Any wristbands where we detected a chemical, but could not quantify it, are suppressed from this chart below."}`



```{r chart_heatmap_x5_activeChemChart, echo=FALSE, message=FALSE,fig.cap="",fig.height=8,dpi=150}
#{r x5_activeChemChart, echo=FALSE, message=FALSE,fig.cap="",dev='svg'}
#{r x5_activeChemChart, echo=FALSE, message=FALSE, fig.height=8,fig.width=5,fig.cap="",dev='svg'}
#options(height = 9)  #this is redundant with the heading setting I THINK but so what

### NOW I KNOW how to do with LONG, not wide so big changes below
#       ... so I did it.... USING testResults below

# MARC TRYING to redo this the "right" way...
# First, start with testResults and do not deal with any rows that are all-zero

#NOW set the colors 
num_Colors_Needed <- length(unique(testResults.big$quartile))
# THIS Is the RIGHT WAY to choose colors
#
#library("colorspace")
#pal <- choose_palette()

# SHOW how to pick colors
#colfunc<-colorRampPalette(c("yellow", "red"))
#n<-10
#colfunc(n)
#plot(rep(1,n),col=colfunc(n),pch=19,cex=3)
#colfunc<-colorRampPalette(c("lightyellow", "red"))
#n<-20
#colfunc(n)
#plot(rep(1,n),col=colfunc(n),pch=19,cex=3)
#colfunc(n)
# MARC picked these colors manually
x5_colors<-c("white" , "#FFE4C8" , "#FFC9B0" , "#FF9381" , "#FF0000")

#ATTEMPTING to eliminate ZERO values from testResults.big with a filter
tr.big.without.NotFound <- testResults.big %>% filter(PureSampleName!="not_found")

x5_activeChemChart <- ggplot(
    #testResults.big,
    #testResults,
    #ATTEMPTING to eliminate ZERO values from testResults.big with a filter
    tr.big.without.NotFound, #Get rid of all rows that have NO values set
    aes(
        y = factor(ParameterName,
                   levels = sort(unique(ParameterName),
                                 decreasing = TRUE)),
        x = SampleNumber,
        fill = factor(quartile)),
    ylab = NULL,
    xlab = NULL
    ) + 
    geom_tile() + 
    scale_fill_manual(values = x5_colors,
                      name = "Relative \n Amount",
                      breaks=c("0","1", "2", "3","4"),
                      labels=c("None","Bottom 25%", "2nd 25%", "3rd 25%","Top 25%")
                      )
#x5_activeChemChart
# Make a list of all black repeated the number of times we have subjects in the experiment
x5_columnColors = rep("black",howManyWristbandsTested)
# Change ONE item on the list to be the color we're going to use for highlighting

if (! HideIndividualization) {  # Supress setting color of SampleName if we are trying to hide individualization
  x5_columnColors[which (colnames(results_W)==subject)]<-"seagreen"     # was RED >>>   "#d7191c"
} 

# if (howManyWristbandsTested<=120) {
#   x_axis_font_size = 6
# } else {
#   x_axis_font_size = 4
# }
#SET FONT SIZE for X axis Labels
if (howManyWristbandsTested<=60) {
  x_axis_font_size = 12
} else if (howManyWristbandsTested <= 120) {
  x_axis_font_size = 6
} else {
  x_axis_font_size = 4
}
#SET FONT SIZE for Y axis Labels
if (howManyUniqueChemFoundAcrossAllWristbands<=60) {
  y_axis_font_size = 10
} else if (howManyUniqueChemFoundAcrossAllWristbands <= 90) {
  y_axis_font_size = 8
} else if (howManyUniqueChemFoundAcrossAllWristbands <= 120) {
  y_axis_font_size = 6
} else {
  y_axis_font_size = 4
}
#hide many items using element_blank() plus set other THEME things
#NOTE that I got an ERROR about 
#   ## Warning: Vectorized input to `element_text()` is not officially supported.
#   # Results may be unexpected or may change in future versions of ggplot2.
#SO i wrapped this in suppressMessagse and suppressWarnings... not sure this was wise
x5_activeChemChart <- x5_activeChemChart + 
  theme(axis.line=element_blank()
        ,axis.ticks=element_blank()
        ,axis.title.y=element_blank()
        ,axis.text.x = suppressMessages(suppressWarnings(   ## NOTE i added this to avoid element_text error
          element_text(angle = 90, 
                       hjust = 1,
                       vjust = 0.4,
                       colour=x5_columnColors
                       #,size=12
                       ,size=x_axis_font_size
          )    ))
        # ,axis.text.y = element_text(angle = 45 
        #   ,hjust = 1
        #  ,size=6)
        #,axis.text.y = element_text(size=6)
        ,axis.text.y = element_text( colour="black",size=y_axis_font_size) 
        #,axis.text.y = element_text(size=4)
        ,legend.position="bottom"
        ,panel.background=element_blank()
        ,panel.border=element_blank()
        ,panel.grid.major=element_blank()
        ,panel.grid.minor=element_blank()
        ,plot.background=element_blank()) 
#x5_activeChemChart


#Setup labels
x5_activeChemChart<-x5_activeChemChart  +
  labs(x="Participants: Black dots show row maxiumum",
       y="Chemicals",
       title="Chemicals Found") 

#Set the, Y label axis text to be dark red and smaller font so it fits
x5_activeChemChart <- x5_activeChemChart + 
  theme(axis.text.y = element_text( colour="black")) 
#x5_activeChemChart

if (! HideIndividualization) {  # If NOT hiding individualization
  #CREATE the SUBSET that is the row of our own subject only
  xs<-testResults.big %>%
    filter(SampleNumber==subject)
  #PUT a dot inside every square in  the column of our subject
  x5_activeChemChart <- x5_activeChemChart+
    geom_point(aes(),data=xs,color="seagreen",size=.1)
} 



## Add a black X shape to mark the maxium values found for each chemical
xm<-testResults.big %>%
  filter(is_this_max==TRUE)
x5_activeChemChart  <- x5_activeChemChart + 
  geom_point(data=xm, mapping=aes(), shape=19, size=1.5)  # was shape=15

#x5_activeChemChart

###
##  NOW i was going to higlight  EVERY CELL with a MAX value BUT I can'd do that using x5_rlnn
#       cause that already is grouped in zero to 5 values...
###
#x5_rlnn %>%
#  group_by(ParameterName) %>%
#  summarize(max(value))


#suppressMessages(suppressWarnings(print(x5_activeChemChart)))
x5_activeChemChart 
#browser()

rm(num_Colors_Needed,x5_colors,x5_columnColors,x5_activeChemChart)

#TRIED to use D3 for heatmap BUT doesn't work w/ sparse matrix
#CONVERT testResults.big into matrix with rows = compounds (as rownames) and columns=Wristbands (as column names)
# t<-testResults.big %>%
#   select(SampleNumber,ParameterName,Result)   %>%
#   filter(Result>0)
# tra<- as.matrix(spread(t,SampleNumber,as.numeric(Result),fill=0))
# tr<-as.matrix(spread(t,SampleNumber,Result,fill=0))
# 
# tr2<-tr[,-1]
# rownames(tr2)<-tr[,1]
# mode(tr2)="numeric"
# d3heatmap(tr2, scale = "column", colors = "Spectral",dendrogram="none")


```



## Total Nanograms found of any Chemicals

Each tested wristband picked up different amounts of different chemicals.  One simple question is "how much total chemical compound, of any type, did each wristband, or each nanogram-of-wristband, pick up?  In other words, if we tested for a list of chemicals, and Wristband-A picked up 10 nanograms of Chemical 1, and 10 nanograms of chemical 2 and none of the other chemicals, then Wristband-A picked up a total of 20 nanograms of chemicals. The exact number is not as interesting as is the SIZE OF THE NUMBER relative to other people who wore the wristband and were tested for the same chemical. 

`r if(nrow(testResults.big[testResults.big[, "Flag"] == "Y", ])>0){"Any wristbands where we detected a chemical, but could not quantify it, are suppressed from this chart below."}`


```{r print_loreal_3b,  results="asis", echo=FALSE,   eval=wristbands_time_adjusted_not_weight}

cat("The numbers were normalized relative to  the length of time the wristband was worn and ",
  "hence can be relatively reliably compared. ",sep="")

```




```{r print_loreal_3, results="asis", echo=FALSE, eval=wristbands_time_and_weight_adjusted}

cat("The numbers were normalized relative to both the size of the wristband and the length of time the wristband was worn and ",
      "hence can be relatively reliably compared.  ",
      sep="")

```

```{r print_weight_only_adjust2, results="asis", echo=FALSE, eval=wristbands_weight_adjusted}

cat("The data is the raw nanograms found in each gram of wristband. " ,sep="")

```


```{r print_chem_response_factor_info, results="asis", echo=FALSE, eval=(RMD_type=='DRS')}

cat("Additionally, the underlying chemical responses are within a factor of 2.5 with respect to accuracy based on the publication ",
      "(https://link.springer.com/article/10.1007/s00216-018-0997-7).",
      sep=" ")

```





`r if(DoSpecificSubjectAnalysis){"Your wristband is in GREEN."}`

```{r chart_total_ng_found, echo=FALSE, message=FALSE, fig.height=6,fig.cap="",dpi=150}
################BEGIN x5 Perc
# IDEA is to get total RESULTS for each WB then graph that  in bar-chart
ng_per_sample <-testResults.big %>%
  group_by(SampleNumber) %>%
  summarise(SumResult=sum(Result))

 c<- ggplot(ng_per_sample, aes(y=SumResult ,factor(SampleNumber),fill=SampleNumber==subject)) +
      geom_bar(stat="identity")+
        labs(x="Every Wristband tested",
         y="Nanograms Found",
         title="Total NG of Any Chemical found")

# c
 #SET FONT SIZE for X axis Labels
 if (howManyWristbandsTested<=60) {
   x_axis_font_size = 10
 } else if (howManyWristbandsTested <= 120) {
   x_axis_font_size = 6
 } else {
   x_axis_font_size = 4
 }
 
c<- c+theme(axis.line=element_blank(),
            axis.ticks=element_blank(),
            axis.title.x=element_blank(),
#            axis.text.x = element_text(angle = 90,vjust=.9,hjust=.5,size=8 ),
            axis.text.x = element_text(angle = 45,vjust=1,hjust=1,size=x_axis_font_size ),
#            axis.text.x = element_text(angle = 90,size=8 ),
            legend.position="none",
            panel.background=element_blank(),
            panel.border=element_blank(),
            panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),
            plot.background=element_blank())

if (HideIndividualization) {
  c <- c + scale_fill_manual(values = c("blue","blue"))
} else {
  c <- c + scale_fill_manual(values = c("blue","seagreen"))
}


c

rm(c)

```



```{r print_loreal_venn, child='loreal_venn_text.Rmd', eval=show_loreal_venn_text}
```

<--

## Numerical Matrixes of all Data


We now provide a few numerical matrixes so you can see the actual numbers that were used as the basis to create the charts above. 

`r if(nrow(testResults.big[testResults.big[, "Flag"] == "Y", ])>0){"Any wristbands where we detected a chemical, but could not quantify it, are suppressed from these matrixes below"}`

-->

```{r print_loreal_2, results="asis", echo=FALSE,   eval=FALSE}
{r print_loreal_2, results="asis", echo=FALSE,   eval=wristbands_week_and_weight_adjusted}
cat("The number is expressed as the number of **nanograms per gram of wristband** and is normalized for being worn for a one week period ",
      "(in other words, if someone wore the wristband for 14 days instead of 7, ",
      "we divided the total result in half to represent just one week of exposure ", 
      "in order to allow easier comparison between wristbands). In other words, if we ",
      "recovered 1,000 nano-grams of chemical X from the wristband, and the wristband weighed 4 grams, ",
      "and the band was worn for 7 days, we would report ",
      "that you had 250 nano-grams /gram of WB per week.  The exact number is not so important as ",
      "is the SIZE OF THE NUMBER relative to other people who wore the ",
      "wristband. ",sep=" ")

```




<-- ### Matrix showing Quartiles


The matrix below shows the result of normalizing the values found, based on the maximum value found, and then breaking up the values into 4 quartiles while leaving those with no-value-found at zero.  In other words, we process each row so that it has only the values 0, 1, 2, 3, and 4.

-->


```{r  x5_pandoc_q, results='asis', echo=FALSE, message=FALSE,eval=FALSE}
{r  x5_pandoc_q, results='asis', echo=FALSE, message=FALSE}
# NOTE that split.table=inf makes sure we never split table and it is as wide as data
# could have used:  
#   panderOptions('table.split.table', 300)
# which I think says ... allow 300 columns

#


## Grab the parts of testResults I want to print which is 
#     chemical name, wristband name (sampleNumber), and what quartile
#     use replace_na to Get rid of all the NA values and replace with quartile of ZERO

### NOTE that I filtered to get rid of Result>0 below BUT if a WB had NO compounds then
#     it didn't show in matrix at ALL which seemed wrong SO...
#     commenting this out and replacing w/ version without filter.
#     HOPEFULLY this doesn't cause other problems?
# quant_data<-testResults.big %>% filter(Result>0) %>%
#   select(ParameterName,SampleNumber,quartile) %>%
#   spread(SampleNumber,quartile) %>%
#   replace(is.na(.), 0) %>%
#   arrange(ParameterName) %>%
#   rename('Chemical Name'=ParameterName) %>%
#   as.data.frame()

### 2/21/2019  NEW VERSION without FILTER
# quant_data<-testResults.big  %>%
#   select(ParameterName,SampleNumber,quartile) %>%
#   distinct() %>%   #When i got rid of FILTER for zero on 2/21 I introduced duplicates maybe this fixes.  Fixed 2/24/2019
#   spread(SampleNumber,quartile) %>%
#   replace(is.na(.), 0) %>%    
#   arrange(ParameterName) %>%
#   dplyr::rename('Chemical Name'=ParameterName) %>%
#   as.data.frame()

## BUT UNFORTUNATELY (11/12/2021) NOW i get a weird "NOT FOUND" value in the rows so THAT didn't work... Try to get rid of that not-found and see if that helps....
#ATTEMPTING to eliminate ZERO values from testResults.big with a filter
tr.big.without.NotFound <- testResults.big %>% filter(PureSampleName!="not_found")
quant_data<-tr.big.without.NotFound  %>%
  select(ParameterName,SampleNumber,quartile) %>%
  distinct() %>%   #When i got rid of FILTER for zero on 2/21 I introduced duplicates maybe this fixes.  Fixed 2/24/2019
  spread(SampleNumber,quartile) %>%
  replace(is.na(.), 0) %>%    
  arrange(ParameterName) %>%
  dplyr::rename('Chemical Name'=ParameterName) %>%
  as.data.frame()








pandoc.table(quant_data,
             caption="Full List of Chemicals"  ,
             justify=c("center"),
             emphasis.rownames=TRUE,
             #split.tables=110  #80 the default
             split.table = Inf
             )

#CLEAN UP
rm(quant_data)

```

```{r dlete_for_SBIR_people, results="asis",  echo=FALSE, eval=FALSE}
[comment]: ### Matrix showing Raw Values


[comment]: In this next matrix (below), you see the same data but it is not mean centered nor broken into quartiles.  


```


```{r print_loreal_4b, results="asis",  echo=FALSE, eval=FALSE}
{r print_loreal_4b, results="asis",  echo=FALSE, eval=wristbands_week_and_weight_adjusted}

cat("More exactly, it is the raw nanograms found in each gram of wristband material ",
      "normalized to time-adjust the values as though the wristband were worn for exactly one week. ",
      sep=" ")

```



```{r print_loreal_4b_2, results="asis",  echo=FALSE, eval=FALSE}
{r print_loreal_4b_2, results="asis",  echo=FALSE, eval=wristbands_time_adjusted_one_week_not_weight}

cat("More exactly, it is the raw nanograms found in each gram of wristband material ",
      "normalized to time-adjust the values as though the wristband were worn for exactly one week. ",
      sep=" ")

```





```{r print_DRS_detection_limit, results="asis" , echo=FALSE, eval =  (RMD_type=='DRS')}

cat("The median value for detection limits across all compounds ",
      "is approximately 200 ng/Wristband or 50ng/gram silicone. ",sep="")

```



```{r print_OTHER_DETECTION_LIMIT, echo=FALSE, eval=FALSE}

WE DO THE MAS15 detect limit above... 
  IF MAS15 THEN
    The median value for detection limits across all compounds is approximately 200 ng/Wristband or 50ng/gram silicone. 

BUT NEED TO DO the other ones
IF PAH then:
  
IF Pesticide THEN:
  
If VOC THEN
  


```


```{r print_loreal_4c2,results="asis", echo=FALSE, eval =  FALSE}

cat("Additionally, since the wristbands can be of different sizes, ",
      "we normalize by size of wristband to create  the raw nanograms ",
      "found in each gram of wristband material in each wristband normalized ",
      "only to time-adjust the values as though the wristband were worn for exactly one week.  ",
      sep=" ")

```


```{r print_loreal_4b2, results="asis", echo=FALSE, eval=wristbands_time_adjusted_one_day}

cat("More exactly, it is the raw nanograms found  in each wristband normalized ",
      "to time-adjust the values as though the wristband were worn for exactly one DAY. ",
      "In other words, if a wristband was worn for 2.5 days, we divided the total " ,
      "nanograms by 2.5 to result in the per day number.  Similarly if the wristband ",
      "was worn for 5 days, we divided the total nanograms by 5 to result in the per day number. ",
      "The median value for detection limits across all  compuonds is ",
      "approximately 200 ng/Wristband or 50ng/gram.",
      sep="") 

```


```{r  skip_for_SBIR, results='asis', echo=FALSE, message=FALSE, eval=FALSE}

[comment]: Therefore, these data give you a more direct sense of "how much" of a given chemical was found.  Having said that, since chemicals enter the wristband at different rates, it is incorrect to try to deduce relative exposures between compounds.  Numerical data should be compared amongst participants for one compound at-a-time. Numbers also have variability depending on the specific compound and analytical performance.  Having provided that disclaimer, however, we're still showing the scientifically accurate "how much we found" information below which is in nanograms.  Compounds not found and/or below the limit-of-detection are shown as zero values.

```



```{r  pandoc_X_NOT_normalized, results='asis', echo=FALSE, message=FALSE, eval=FALSE}

# NEED TO SORT X2 so it matches the chart above

### Grab the rows from testResults I need to print this data matrix
#     rename them for better reading and print matris of all raw values for all chems /WB's
#     use replace_na to Get rid of all the NA values and replace with quartile of ZERO

### 2/21/2019  COMMENT OUT version with FILTER and replace with version with NO FILTER of zero vales
# raw_data<-testResults.big %>%
#   filter(Result>0)%>%
#   select(ParameterName,SampleNumber,Result) %>%
#   spread(SampleNumber,Result) %>%
#   replace(is.na(.), 0) %>%    
#   arrange(ParameterName) %>%
#   rename('Chemical Name'=ParameterName) %>%
#   as.data.frame()

#ATTEMPTING to eliminate ZERO values from testResults.big with a filter
tr.big.without.NotFound <- testResults.big %>% filter(PureSampleName!="not_found")

### 2/21/2019  COMMENT OUT version with FILTER and replace with version with NO FILTER of zero vales
### 11/12/2021 BUT then i got rows with "not_found" so I then filter THAT out which may recreate OTHER problem but....
raw_data<-tr.big.without.NotFound %>%
  select(ParameterName,SampleNumber,Result) %>%
  distinct() %>%
  spread(SampleNumber,Result) %>%
  replace(is.na(.), 0) %>%    
  arrange(ParameterName) %>%
  dplyr::rename('Chemical Name'=ParameterName) %>%
  as.data.frame()

pandoc.table(raw_data,
             caption="Full List of Chemicals"  ,
             justify=c("center"),
             emphasis.rownames=TRUE,
             #split.tables=110  #80 the default
             split.table = Inf
             )

#CLEAN UP
rm(raw_data)

```




<br>
<br>





```{r testingPrePostProcessing, child='testPrePostProcessing.Rmd', eval = (testing_PRE_POST && nrow(testResultsPrePost)>=2) }
```

# Additional Information


## Summary report on Wristband vs Other devices:


* This project was a significant success.  We exceeded our expectations regarding scientific outcomes with high levels of predictability regarding our key questions.
    * Wristbands resulted in significantly more data and remain the preferred approach among the three devices.
    * The comparison of the three sets of device results allows us to predict which compounds are coming from the air, which from the skin, and which are a mix of routes of exposure.
        * With this relatively small data set we were able to achieve between 65% and 85% accuracy in predictions.  We anticipate this will improve as we add more people to this project!
        * MyExposome intends to pursue an additional grant which will significantly improve the ability of all scientists using wristbands to predict source of exposure. 
    * In terms of the number of compounds detected and quantity of each compound detected , it is  apparent that wristbands resulted in significantly more data overall.
        * For VOLATILE compounds (compounds which evaporate at room temperature)  there are no dramatic differences between wristband vs necklace vs bracelet results although wristbands remain most robust.
        * For Semi-VOLATILE compounds (compounds with higher boiling points) there is a dramatic improvement in detection by the wristband versus the alternatives, suggesting that the wristbands capture from more routes of exposure than air alone.

&nbsp;



```{r FullChemList, eval=FALSE, results='asis', echo=FALSE, message=FALSE}
####I'm SUPPRESSING the full list, for now, because it is LONG.  Taking first 10 rows only.
#### The full list of all chemicals tested can be found online at: `r URL_of_Chemicals_Tested`

#mP<-masterParam[1:10,c("ParameterName","CASNumber")]
mP<-masterParam[1:min(nrow(masterParam),100),
                c("ParameterName","CASNumber")]
names(mP)<-c("Chemical Name", "CAS Number")
#knitr::kable(mP[1:10,],format="markdown")

pandoc.table(mP,
             caption="Full List of Chemicals",
             justify=c("left","center"),
             emphasis.rownames=TRUE,
             split.table = Inf
             )
rm(mP)

```


<br>
<br>





## Other information about this report


```{r Versions,  results='asis', echo=FALSE, message=FALSE}
info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
today <- Sys.Date()

```


All analyses were performed using R (ver. `r r_ver`)[R Core Team, 2013]  and knitr (ver `r info$otherPkgs$knitr$Version`) [Xie, 2013] for reproducible research.  &nbsp;
<br>

Report run on `r format(today,"%m/%d/%y")`.  

This information is made available to you by MyExposome, Inc.  Refer to www.MyExposome.com for our standard terms and conditions.  We do not provide medical advice. The Information provided is for research, informational, entertainment and educational use only as a result of the current research-based state of our approach. The Services are not intended to be used by the customer for any diagnostic purpose and are not a substitute for medical advice. 

Report contents, structure, and results copyright(c) MyExposome, Inc.  All rights reserved.
